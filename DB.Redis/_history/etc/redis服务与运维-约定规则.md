# redis服务与运维-约定规则

- 不允许重复使用端口
  - redis端⼝从6379开始,逐渐递增,同时,端⼝不允许重复。即如果6379被机票某个业务使⽤,就不能再被其他任何业务使用,直到该端⼝被下线回收。
  - 注意：查看当前redis的端口的列表，请登录哨兵机器，直接查看配置文件列表，即可看到当前所有正在使用的端口。默认下一个业务的端口在当前最大的端口后加1即可
- 不允许出现端口异构
  - 同一套具有主从关系的redis,端⼝必须相同。即主库端⼝为6379,从库端⼝必须为6379。不允许出现端⼝异构。
- 多台哨兵机器的配置文件必须相同
  - 监控同⼀套redis集群的哨兵配置⽂件必须相同。所有哨兵均具有对等的failover能力。这样保证不会因为某个哨兵挂掉而剩下的哨兵因为某些限制不能完成主从切换
- 哨兵端口与redis端口的关系
  - 哨兵端口 == str(2) + redis端口
  - 例如，redis端口为6379.那么监控这个集群的哨兵的端口就是26379
- 注意：redis在部署的时候就需要严格的sharding，同一套redis资源中不能存储不相关业务的redis内容。也就是redis资源一开始就需要严格做好垂直拆分。

- 注意，为了实现redis的高可用:
  1. 每套redis都至少是一主一从。
  2. 不要把主从实例分布在不同的机房。
  3. 不要把业务逻辑与后端redis分布在不同机房。

------

# redis服务使用申请须知-研发人员关注


由于服务器并不总是有空闲的资源，以及高可用集群环境的部署需要时间，请必须至少提前2个工作日申请，少于2个工作日的，dba可以拒绝。

如果使用dba提供的redis服务，就必须使用dba提供的java-client，否则redis集群将无法正常的进行高可用切换！切记！

请在申请redis服务的邮件中，准确描述以下全部7个问题（缺一不可），如果对下面的问题有疑问，请提前咨询dba

- redis使用方式：cache vs storage
  - redis是作为缓存,还是作为存储使用?
  - 作为缓存的话，业务方必须为每个key都设置过期时间；
  - 作为存储使用，业务方需要考虑数据的清洗策略，否则redis的内存量会一直增长，最终达到上限，导致服务不可用。
  - 对同一套redis的使用，不要出现部分key设置了过期时间，另外部分key没有设置过期时间的情况。

- 内存使用量，以及未来的增长趋势如何?
  - 预计整个业务单份内存量,5G/10G/20G还是更多?未来2年内会增⻓到大概多少G?
  - redis内存使用量估算方式：（key的平均长度+value的平均长度）*kv的个数*2
  - redis内存的估算本身很复杂，与key是否设置了过期时间，key的大小，value的类型和大小，value采用的编码和存储方式，redis实例自身垃圾回收的速度，每秒写入量的大小等都相关。所以乘以2是比较保守的估算方式。
  - 对内存资源的评估请本着认真负责的态度，既要能满足业务扩展的需求，又要杜绝资源的浪费。

- qps量，以及未来的增长趋势如何？
  - 整个redis集群需要提供的qps量，1w、2w还是5w，甚至更多？未来1-2年预估会达到多少？
  - qps在5000以下的，请优先考虑使用mysql，我们的mysql可以满足绝大部分业务需求，同时提供更好的高可用和数据安全解决方案。对于qps很小（例如只有几百甚至几十的qps），但是业务场景非常适合使用Redis的，请说明具体原因。

- 业务使用的命令?
  - 业务要列举用到的命令，这样方便DBA对业务更深入的理解，帮助业务优化和定位问题。
  - 比如：
    - 读命令：get, lrange, hget 等等
    - 写（或读写）命令：setex, set, lpush, lpop 等等
    - 注：部分高危命令已被dba屏蔽，即使有密码也无法使用，被屏蔽的命令列表：xxx
  - 机房部署
    - redis需要部署在哪个机房(cn1/cn6/cn8)?
    - 是否有跨机房部署需求?我们一般不推荐跨机房部署redis。例如如果前端和业务逻辑都在cn1机房，那么推荐redis也部署在cn1机房

------

1. patch的功能需求
   1. 如果命令来自于白名单列表，那么不管是否设置了密码，都跳过密码验证阶段。目的是为了方便dba的管理和兼容之前的各种监控统计脚本，否则改造代价太大。

   2. 用户即使提供了密码，也无法使用如下高危命令，除非用户的ip地址在白名单中。也即，在白名单中的ip地址，可以执行如下命令。而不在白名单中的ip，即使提供了密码，也不能使用如下的高危命令：

      ```
      bgrewriteaof
      config get
      config set
      config resetstat
      config rewrite
      flushall
      flushdb
      shutdown
      save
      bgsave
      client kill
      client list
      slowlog
      monitor
      slaveof
      info
      ```

2. 线上配置
   127.0.0.1和线上的哨兵机器，以及cacti监控机器的ip地址，都默认在白名单中。

   其余所有机器都均不在白名单中，访问线上redis必须提供密码。