[TOC]

# 实验:范围条件下的锁情况

## 环境
```
mysql> show create table t1\G
*************************** 1. row ***************************
    Table: t1
Create Table: CREATE TABLE `t1` (
 `c1` int unsigned NOT NULL DEFAULT '0',
 `c2` int unsigned NOT NULL DEFAULT '0',
 `c3` int unsigned NOT NULL DEFAULT '0',
 `c4` int unsigned NOT NULL DEFAULT '0',
 PRIMARY KEY (`c1`),
 KEY `c2` (`c2`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)
 
mysql> select * from t1 order by c1;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 0 | 0 | 0 | 0 |
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
7 rows in set (0.00 sec)
```

## >=
### 无索引上范围条件：全表锁。

```
 
mysql> begin ; select * from t1 where c3 >= 4 for update ;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
3 rows in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 139620969519720:1073:139620864029240  |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX    | GRANTED   | NULL          |
| INNODB | 139620969519720:16:4:1:139620864026200 |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:16:4:2:139620864026200 |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 0           |
| INNODB | 139620969519720:16:4:3:139620864026200 |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 1           |
| INNODB | 139620969519720:16:4:4:139620864026200 |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 3           |
| INNODB | 139620969519720:16:4:5:139620864026200 |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 4           |
| INNODB | 139620969519720:16:4:6:139620864026200 |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 6           |
| INNODB | 139620969519720:16:4:8:139620864026200 |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 10           |
| INNODB | 139620969519720:16:4:9:139620864026200 |         2546 |    103 |    27 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 8           |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
9 rows in set (0.00 sec)
```

### 有主键表，使用普通索引上范围条件：等值条件也会上ordinary，范围条件上ordinary ，同时回溯主键上lock_rec_not_gap
```
mysql> begin ; select * from t1 where c2 >= 4 for update ;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 10 | 4 | 4 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
+----+----+----+----+
3 rows in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 139620969519720:1073:139620864029240  |         2548 |    103 |    37 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL          |
| INNODB | 139620969519720:16:5:1:139620864026200 |         2548 |    103 |    37 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:16:5:7:139620864026200 |         2548 |    103 |    37 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 6, 6          |
| INNODB | 139620969519720:16:5:8:139620864026200 |         2548 |    103 |    37 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 4, 10         |
| INNODB | 139620969519720:16:5:9:139620864026200 |         2548 |    103 |    37 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 8, 8          |
| INNODB | 139620969519720:16:4:6:139620864026544 |         2548 |    103 |    37 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 6           |
| INNODB | 139620969519720:16:4:8:139620864026544 |         2548 |    103 |    37 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 10           |
| INNODB | 139620969519720:16:4:9:139620864026544 |         2548 |    103 |    37 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 8           |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
8 rows in set (0.00 sec)
 
mysql> begin ; select * from t1 where c2 > 4 for update ;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
+----+----+----+----+
2 rows in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 139620969519720:1073:139620864029240  |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL          |
| INNODB | 139620969519720:16:5:1:139620864026200 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:16:5:7:139620864026200 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 6, 6          |
| INNODB | 139620969519720:16:5:9:139620864026200 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 8, 8          |
| INNODB | 139620969519720:16:4:6:139620864026544 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 6           |
| INNODB | 139620969519720:16:4:9:139620864026544 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 8           |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
6 rows in set (0.00 sec)
 
mysql> begin ; select * from t1 where c2 = 4 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 10 | 4 | 4 | 0 |
+----+----+----+----+
1 row in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 139620969520592:1073:139620864035192  |         2553 |    104 |    38 | kk      | t1     | NULL      | NULL       | NULL    |    139620864035192 | TABLE   | IX      | GRANTED   | NULL          |
| INNODB | 139620969520592:16:5:8:139620864032264 |         2553 |    104 |    38 | kk      | t1     | NULL      | NULL       | c2     |    139620864032264 | RECORD  | X       | GRANTED   | 4, 10         |
| INNODB | 139620969520592:16:4:8:139620864032608 |         2553 |    104 |    38 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864032608 | RECORD  | X,REC_NOT_GAP | GRANTED   | 10           |
| INNODB | 139620969520592:16:5:7:139620864032952 |         2553 |    104 |    38 | kk      | t1     | NULL      | NULL       | c2     |    139620864032952 | RECORD  | X,GAP     | GRANTED   | 6, 6          |
| INNODB | 139620969519720:1073:139620864029240  |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL          |
| INNODB | 139620969519720:16:5:1:139620864026200 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:16:5:7:139620864026200 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 6, 6          |
| INNODB | 139620969519720:16:5:9:139620864026200 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 8, 8          |
| INNODB | 139620969519720:16:4:6:139620864026544 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 6           |
| INNODB | 139620969519720:16:4:9:139620864026544 |         2552 |    103 |    41 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 8           |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
10 rows in set (0.00 sec)
```

### 试一下只有辅助索引的表上的范围条件：虽然没有主键，但是在聚集索引上加了lock_rec_not_gap
```
mysql> show create table tnoi \G
*************************** 1. row ***************************
    Table: tnoi
Create Table: CREATE TABLE `tnoi` (
 `c1` int unsigned NOT NULL DEFAULT '0',
 `c2` int unsigned NOT NULL DEFAULT '0',
 `c3` int unsigned NOT NULL DEFAULT '0',
 `c4` int unsigned NOT NULL DEFAULT '0',
 KEY `c2` (`c2`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)
 
mysql> select * from tnoi;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 0 | 0 | 0 | 0 |
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
7 rows in set (0.00 sec)
 
mysql> begin ; select * from tnoi where c2 >= 4 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 10 | 4 | 4 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
+----+----+----+----+
3 rows in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 139620969519720:1080:139620864029240  |         2612 |    103 |    55 | kk      | tnoi    | NULL      | NULL       | NULL      |    139620864029240 | TABLE   | IX      | GRANTED   | NULL          |
| INNODB | 139620969519720:23:5:1:139620864026200 |         2612 |    103 |    55 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:23:5:6:139620864026200 |         2612 |    103 |    55 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 6, 0x000000001714   |
| INNODB | 139620969519720:23:5:7:139620864026200 |         2612 |    103 |    55 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 8, 0x000000001715   |
| INNODB | 139620969519720:23:5:8:139620864026200 |         2612 |    103 |    55 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 4, 0x000000001716   |
| INNODB | 139620969519720:23:4:6:139620864026544 |         2612 |    103 |    55 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001714     |
| INNODB | 139620969519720:23:4:7:139620864026544 |         2612 |    103 |    55 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001715     |
| INNODB | 139620969519720:23:4:8:139620864026544 |         2612 |    103 |    55 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001716     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+---------------+-------------+------------------------+
8 rows in set (0.00 sec)
```
### 使用主键时：等值上lock_rec_not_gap，范围上lock_ordinary直到最大虚拟值。
```
mysql> begin ; select * from t1 where c1 >= 6 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
3 rows in set (0.01 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 139620969519720:1073:139620864029240  |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL          |
| INNODB | 139620969519720:16:4:6:139620864026200 |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X,REC_NOT_GAP | GRANTED   | 6           |
| INNODB | 139620969519720:16:4:1:139620864026544 |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X       | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:16:4:8:139620864026544 |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X       | GRANTED   | 10           |
| INNODB | 139620969519720:16:4:9:139620864026544 |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X       | GRANTED   | 8           |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
5 rows in set (0.00 sec)
 
mysql> begin ; select * from t1 where c1 = 4 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 4 | 2 | 2 | 0 |
+----+----+----+----+
1 row in set (0.00 sec)
 
mysql> insert into t1 select 5,5,5,5;
Query OK, 1 row affected (0.01 sec)
Records: 1 Duplicates: 0 Warnings: 0
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 139620969520592:1073:139620864035192  |         2642 |    104 |    72 | kk      | t1     | NULL      | NULL       | NULL    |    139620864035192 | TABLE   | IX      | GRANTED   | NULL          |
| INNODB | 139620969520592:16:4:5:139620864032264 |         2642 |    104 |    72 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864032264 | RECORD  | X,REC_NOT_GAP | GRANTED   | 4           |
| INNODB | 139620969519720:1073:139620864029240  |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL          |
| INNODB | 139620969519720:16:4:6:139620864026200 |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X,REC_NOT_GAP | GRANTED   | 6           |
| INNODB | 139620969519720:16:4:1:139620864026544 |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X       | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:16:4:8:139620864026544 |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X       | GRANTED   | 10           |
| INNODB | 139620969519720:16:4:9:139620864026544 |         2641 |    103 |    94 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X       | GRANTED   | 8           |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
7 rows in set (0.00 sec)
```

## <=

### 主键上的<= 条件范围： 等值和范围都加lock_ordinary。 8.0.18之前，也会对下一个不符合条件的记录加ordinary。
```
mysql> select * from t1;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
6 rows in set (0.00 sec)
 
mysql> begin ; select * from t1 where c1 <= 4 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
+----+----+----+----+
3 rows in set (0.00 sec)
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 139620969519720:1073:139620864029240  |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX    | GRANTED   | NULL   |
| INNODB | 139620969519720:16:4:3:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 1     |
| INNODB | 139620969519720:16:4:4:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 3     |
| INNODB | 139620969519720:16:4:5:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 4     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
4 rows in set (0.00 sec)
```

### 验证一下4下一个值前的gap：不再锁下一个值的gap。
```
mysql> begin ; select * from t1 where c1 = 6 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 6 | 6 | 5 | 0 |
+----+----+----+----+
1 row in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 139620969520592:1073:139620864035192  |         2632 |    104 |    58 | kk      | t1     | NULL      | NULL       | NULL    |    139620864035192 | TABLE   | IX      | GRANTED   | NULL   |
| INNODB | 139620969520592:16:4:6:139620864032264 |         2632 |    104 |    58 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864032264 | RECORD  | X,REC_NOT_GAP | GRANTED   | 6     |
| INNODB | 139620969519720:1073:139620864029240  |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL   |
| INNODB | 139620969519720:16:4:3:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X       | GRANTED   | 1     |
| INNODB | 139620969519720:16:4:4:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X       | GRANTED   | 3     |
| INNODB | 139620969519720:16:4:5:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X       | GRANTED   | 4     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
6 rows in set (0.00 sec)
 
mysql> insert into t1 select 5,5,5,5;
Query OK, 1 row affected (0.00 sec)
Records: 1 Duplicates: 0 Warnings: 0
```

### 验证一下最小有效值1前面的gap：直接锁到最小虚拟记录。
```
mysql> insert into t1 select 0,0,0,0;
--hang
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE       | LOCK_STATUS | LOCK_DATA |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
| INNODB | 139620969520592:1073:139620864035192  |         2632 |    104 |    58 | kk      | t1     | NULL      | NULL       | NULL    |    139620864035192 | TABLE   | IX           | GRANTED   | NULL   |
| INNODB | 139620969520592:16:4:6:139620864032264 |         2632 |    104 |    58 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864032264 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 6     |
| INNODB | 139620969520592:16:4:3:139620864032608 |         2632 |    104 |    60 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864032608 | RECORD  | X,GAP,INSERT_INTENTION | WAITING   | 1     |
| INNODB | 139620969519720:1073:139620864029240  |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX           | GRANTED   | NULL   |
| INNODB | 139620969519720:16:4:3:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X           | GRANTED   | 1     |
| INNODB | 139620969519720:16:4:4:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X           | GRANTED   | 3     |
| INNODB | 139620969519720:16:4:5:139620864026200 |         2631 |    103 |    77 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X           | GRANTED   | 4     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
7 rows in set (0.00 sec)
```

### 验证一下无等值情况下是否锁4这个记录：不锁等值，只锁4前的gap（因为小于等于4的值在4前面。）
```
mysql> begin ; select * from t1 where c1 < 4 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
+----+----+----+----+
2 rows in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 139620969519720:1073:139620864029240  |         2637 |    103 |    84 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX    | GRANTED   | NULL   |
| INNODB | 139620969519720:16:4:3:139620864026200 |         2637 |    103 |    84 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 1     |
| INNODB | 139620969519720:16:4:4:139620864026200 |         2637 |    103 |    84 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X     | GRANTED   | 3     |
| INNODB | 139620969519720:16:4:5:139620864026544 |         2637 |    103 |    84 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,GAP   | GRANTED   | 4     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
4 rows in set (0.00 sec)
 
mysql> begin ; select * from t1 where c1 = 4 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 4 | 2 | 2 | 0 |
+----+----+----+----+
1 row in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 139620969520592:1073:139620864035192  |         2638 |    104 |    64 | kk      | t1     | NULL      | NULL       | NULL    |    139620864035192 | TABLE   | IX      | GRANTED   | NULL   |
| INNODB | 139620969520592:16:4:5:139620864032264 |         2638 |    104 |    64 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864032264 | RECORD  | X,REC_NOT_GAP | GRANTED   | 4     |
| INNODB | 139620969519720:1073:139620864029240  |         2637 |    103 |    84 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL   |
| INNODB | 139620969519720:16:4:3:139620864026200 |         2637 |    103 |    84 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X       | GRANTED   | 1     |
| INNODB | 139620969519720:16:4:4:139620864026200 |         2637 |    103 |    84 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X       | GRANTED   | 3     |
| INNODB | 139620969519720:16:4:5:139620864026544 |         2637 |    103 |    84 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,GAP     | GRANTED   | 4     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
6 rows in set (0.00 sec)
```

### 包含主键的表，辅助索引上的条件范围：普通辅助索引条件时，还是对辅助索引列下一个不符合条件的值加了锁，<font color=red>经过验证加的是ordinary</font>。回溯主键加lock_rec_not_gap
```
mysql> select * from t1;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1  | 1  | 1  | 0  |
| 3  | 3  | 3  | 0  |
| 4  | 2  | 2  | 0  |
| 6  | 6* | 5  | 0  |
| 8  | 8* | 8  | 8  |
| 10 | 4  | 4  | 0  |
+----+----+----+----+
6 rows in set (0.00 sec)
 
mysql> begin ; select * from t1 where c2 <= 6 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1 | 1 | 1 | 0 |
| 4 | 2 | 2 | 0 |
| 3 | 3 | 3 | 0 |
| 10 | 4 | 4 | 0 |
| 6 | 6 | 5 | 0 |
+----+----+----+----+
5 rows in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 139620969519720:1073:139620864029240  |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL   |
| INNODB | 139620969519720:16:5:3:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 1, 1   |
| INNODB | 139620969519720:16:5:4:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 3, 3   |
| INNODB | 139620969519720:16:5:5:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 2, 4   |
| INNODB | 139620969519720:16:5:7:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 6, 6   |
| INNODB | 139620969519720:16:5:8:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 4, 10   |
| INNODB | 139620969519720:16:5:9:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 8, 8   |
| INNODB | 139620969519720:16:4:3:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 1     |
| INNODB | 139620969519720:16:4:4:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 3     |
| INNODB | 139620969519720:16:4:5:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 4     |
| INNODB | 139620969519720:16:4:6:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 6     |
| INNODB | 139620969519720:16:4:8:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 10    |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
12 rows in set (0.00 sec)
 
```

### 普通辅助索引条件时，还是对下一个不符合条件的值加了锁，经过验证加的是ordinary

```
mysql> begin ; select * from t1 where c2 = 8 for update;
Query OK, 0 rows affected (0.00 sec)
--hang
 
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 139620969520592:1073:139620864035192  |         2645 |    104 |    80 | kk      | t1     | NULL      | NULL       | NULL    |    139620864035192 | TABLE   | IX      | GRANTED   | NULL   |
| INNODB | 139620969520592:16:5:9:139620864032264 |         2645 |    104 |    80 | kk      | t1     | NULL      | NULL       | c2     |    139620864032264 | RECORD  | X       | WAITING   | 8, 8   |
| INNODB | 139620969519720:1073:139620864029240  |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX      | GRANTED   | NULL   |
| INNODB | 139620969519720:16:5:3:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 1, 1   |
| INNODB | 139620969519720:16:5:4:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 3, 3   |
| INNODB | 139620969519720:16:5:5:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 2, 4   |
| INNODB | 139620969519720:16:5:7:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 6, 6   |
| INNODB | 139620969519720:16:5:8:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 4, 10   |
| INNODB | 139620969519720:16:5:9:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X       | GRANTED   | 8, 8   |
| INNODB | 139620969519720:16:4:3:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 1     |
| INNODB | 139620969519720:16:4:4:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 3     |
| INNODB | 139620969519720:16:4:5:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 4     |
| INNODB | 139620969519720:16:4:6:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 6     |
| INNODB | 139620969519720:16:4:8:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 10    |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
14 rows in set (0.00 sec)
说明记录被锁
 
mysql> begin ; insert into t1 select 7,7,7,7;
Query OK, 0 rows affected (0.00 sec)
--hang
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE       | LOCK_STATUS | LOCK_DATA |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
| INNODB | 139620969520592:1073:139620864035192  |         2647 |    104 |    89 | kk      | t1     | NULL      | NULL       | NULL    |    139620864035192 | TABLE   | IX           | GRANTED   | NULL   |
| INNODB | 139620969520592:16:5:9:139620864032264 |         2647 |    104 |    89 | kk      | t1     | NULL      | NULL       | c2     |    139620864032264 | RECORD  | X,GAP,INSERT_INTENTION | WAITING   | 8, 8   |
| INNODB | 139620969519720:1073:139620864029240  |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX           | GRANTED   | NULL   |
| INNODB | 139620969519720:16:5:3:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X           | GRANTED   | 1, 1   |
| INNODB | 139620969519720:16:5:4:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X           | GRANTED   | 3, 3   |
| INNODB | 139620969519720:16:5:5:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X           | GRANTED   | 2, 4   |
| INNODB | 139620969519720:16:5:7:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X           | GRANTED   | 6, 6   |
| INNODB | 139620969519720:16:5:8:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X           | GRANTED   | 4, 10   |
| INNODB | 139620969519720:16:5:9:139620864026200 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X           | GRANTED   | 8, 8   |
| INNODB | 139620969519720:16:4:3:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 1     |
| INNODB | 139620969519720:16:4:4:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 3     |
| INNODB | 139620969519720:16:4:5:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 4     |
| INNODB | 139620969519720:16:4:6:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 6     |
| INNODB | 139620969519720:16:4:8:139620864026544 |         2643 |    103 |   101 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 10    |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
14 rows in set (0.00 sec)
 
说明gap被锁。
```

### 试验对只有辅助索引的表做范围条件，估计和>=一样，会用上聚集索引： 是这样的，验证了。
```
mysql> show create table tnoi;
| Table | Create Table
| tnoi | CREATE TABLE `tnoi` (
 `c1` int unsigned NOT NULL DEFAULT '0',
 `c2` int unsigned NOT NULL DEFAULT '0',
 `c3` int unsigned NOT NULL DEFAULT '0',
 `c4` int unsigned NOT NULL DEFAULT '0',
 KEY `c2` (`c2`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |
1 row in set (0.00 sec)
 
mysql> select * from tnoi;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 0 | 0 | 0 | 0 |
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
| 1 | 1 | 1 | 1 |
+----+----+----+----+
8 rows in set (0.00 sec)
 
mysql> begin ; select * from tnoi where c2 <= 6 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 0 | 0 | 0 | 0 |
| 1 | 1 | 1 | 0 |
| 1 | 1 | 1 | 1 |
| 4 | 2 | 2 | 0 |
| 3 | 3 | 3 | 0 |
| 10 | 4 | 4 | 0 |
| 6 | 6 | 5 | 0 |
+----+----+----+----+
7 rows in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+---------------+-------------+-------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE   | LOCK_STATUS | LOCK_DATA     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+---------------+-------------+-------------------+
| INNODB | 139620969519720:1080:139620864029240  |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | NULL      |    139620864029240 | TABLE   | IX      | GRANTED   | NULL       |
| INNODB | 139620969519720:23:5:2:139620864026200 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 0, 0x000000001710 |
| INNODB | 139620969519720:23:5:3:139620864026200 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 1, 0x000000001711 |
| INNODB | 139620969519720:23:5:4:139620864026200 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 3, 0x000000001712 |
| INNODB | 139620969519720:23:5:5:139620864026200 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 2, 0x000000001713 |
| INNODB | 139620969519720:23:5:6:139620864026200 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 6, 0x000000001714 |
| INNODB | 139620969519720:23:5:7:139620864026200 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 8, 0x000000001715 |
| INNODB | 139620969519720:23:5:8:139620864026200 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 4, 0x000000001716 |
| INNODB | 139620969519720:23:5:9:139620864026200 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X       | GRANTED   | 1, 0x000000001717 |
| INNODB | 139620969519720:23:4:2:139620864026544 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001710  |
| INNODB | 139620969519720:23:4:3:139620864026544 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001711  |
| INNODB | 139620969519720:23:4:4:139620864026544 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001712  |
| INNODB | 139620969519720:23:4:5:139620864026544 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001713  |
| INNODB | 139620969519720:23:4:6:139620864026544 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001714  |
| INNODB | 139620969519720:23:4:8:139620864026544 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001716  |
| INNODB | 139620969519720:23:4:9:139620864026544 |         2648 |    103 |   108 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP | GRANTED   | 0x000000001717  |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+---------------+-------------+-------------------+
16 rows in set (0.00 sec)
 
mysql> begin ; insert into tnoi select 7,7,7,7;
Query OK, 0 rows affected (0.00 sec)
--hang
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+------------------------+-------------+-------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE       | LOCK_STATUS | LOCK_DATA     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+------------------------+-------------+-------------------+
| INNODB | 139620969520592:1080:139620864035192  |         2654 |    104 |    93 | kk      | tnoi    | NULL      | NULL       | NULL      |    139620864035192 | TABLE   | IX           | GRANTED   | NULL       |
| INNODB | 139620969520592:23:5:7:139620864032264 |         2654 |    104 |    93 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864032264 | RECORD  | X,GAP,INSERT_INTENTION | WAITING   | 8, 0x000000001715 |
| INNODB | 139620969519720:1080:139620864029240  |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | NULL      |    139620864029240 | TABLE   | IX           | GRANTED   | NULL       |
| INNODB | 139620969519720:23:5:2:139620864026200 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X           | GRANTED   | 0, 0x000000001710 |
| INNODB | 139620969519720:23:5:3:139620864026200 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X           | GRANTED   | 1, 0x000000001711 |
| INNODB | 139620969519720:23:5:4:139620864026200 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X           | GRANTED   | 3, 0x000000001712 |
| INNODB | 139620969519720:23:5:5:139620864026200 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X           | GRANTED   | 2, 0x000000001713 |
| INNODB | 139620969519720:23:5:6:139620864026200 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X           | GRANTED   | 6, 0x000000001714 |
| INNODB | 139620969519720:23:5:7:139620864026200 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X           | GRANTED   | 8, 0x000000001715 |
| INNODB | 139620969519720:23:5:8:139620864026200 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X           | GRANTED   | 4, 0x000000001716 |
| INNODB | 139620969519720:23:5:9:139620864026200 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | c2       |    139620864026200 | RECORD  | X           | GRANTED   | 1, 0x000000001717 |
| INNODB | 139620969519720:23:4:2:139620864026544 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 0x000000001710  |
| INNODB | 139620969519720:23:4:3:139620864026544 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 0x000000001711  |
| INNODB | 139620969519720:23:4:4:139620864026544 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 0x000000001712  |
| INNODB | 139620969519720:23:4:5:139620864026544 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 0x000000001713  |
| INNODB | 139620969519720:23:4:6:139620864026544 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 0x000000001714  |
| INNODB | 139620969519720:23:4:8:139620864026544 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 0x000000001716  |
| INNODB | 139620969519720:23:4:9:139620864026544 |         2653 |    103 |   113 | kk      | tnoi    | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026544 | RECORD  | X,REC_NOT_GAP     | GRANTED   | 0x000000001717  |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+------------------------+-------------+-------------------+
18 rows in set (0.00 sec)
```

### 完全无索引：全表锁
```
mysql> select * from t2;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
6 rows in set (0.00 sec)
 
mysql> begin ; select * from t2 where c2 <= 6 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
| 6 | 6 | 5 | 0 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
5 rows in set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 139620969519720:1082:139620864029240  |         2728 |    103 |   139 | kk      | t2     | NULL      | NULL       | NULL      |    139620864029240 | TABLE   | IX    | GRANTED   | NULL          |
| INNODB | 139620969519720:25:4:1:139620864026200 |         2728 |    103 |   139 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:25:4:2:139620864026200 |         2728 |    103 |   139 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171A     |
| INNODB | 139620969519720:25:4:3:139620864026200 |         2728 |    103 |   139 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171B     |
| INNODB | 139620969519720:25:4:4:139620864026200 |         2728 |    103 |   139 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171C     |
| INNODB | 139620969519720:25:4:5:139620864026200 |         2728 |    103 |   139 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171D     |
| INNODB | 139620969519720:25:4:6:139620864026200 |         2728 |    103 |   139 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171E     |
| INNODB | 139620969519720:25:4:7:139620864026200 |         2728 |    103 |   139 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171F     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+-----------+-------------+------------------------+
8 rows in set (0.00 sec)
```

### 无索引表，等值查询，记录不存在：全表锁
```
mysql> select * from t2;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
6 rows in set (0.00 sec)
 
mysql> begin; select * from t2 where c1 = 7 for update ;
Query OK, 0 rows affected (0.00 sec)
 
Empty set (0.00 sec)
 
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 139620969519720:1082:139620864029240  |         2731 |    103 |   657 | kk      | t2     | NULL      | NULL       | NULL      |    139620864029240 | TABLE   | IX    | GRANTED   | NULL          |
| INNODB | 139620969519720:25:4:1:139620864026200 |         2731 |    103 |   657 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:25:4:2:139620864026200 |         2731 |    103 |   657 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171A     |
| INNODB | 139620969519720:25:4:3:139620864026200 |         2731 |    103 |   657 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171B     |
| INNODB | 139620969519720:25:4:4:139620864026200 |         2731 |    103 |   657 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171C     |
| INNODB | 139620969519720:25:4:5:139620864026200 |         2731 |    103 |   657 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171D     |
| INNODB | 139620969519720:25:4:6:139620864026200 |         2731 |    103 |   657 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171E     |
| INNODB | 139620969519720:25:4:7:139620864026200 |         2731 |    103 |   657 | kk      | t2     | NULL      | NULL       | GEN_CLUST_INDEX |    139620864026200 | RECORD  | X     | GRANTED   | 0x00000000171F     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+-----------------+-----------------------+-----------+-----------+-------------+------------------------+
8 rows in set (0.00 sec)
```

### 只有辅助索引，等值查询，记录不存在：锁gap
```
mysql> select * from tnoi;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 0 | 0 | 0 | 0 |
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
| 4 | 2 | 2 | 0 |
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
| 1 | 1 | 1 | 1 |
+----+----+----+----+
8 rows in set (0.01 sec)
 
mysql> begin ; select * from tnoi where c2 = 7 for update;
Query OK, 0 rows affected (0.00 sec)
 
Empty set (0.00 sec)
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA     |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-------------------+
| INNODB | 139620969519720:1080:139620864029240  |         2732 |    103 |   664 | kk      | tnoi    | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX    | GRANTED   | NULL       |
| INNODB | 139620969519720:23:5:7:139620864026200 |         2732 |    103 |   664 | kk      | tnoi    | NULL      | NULL       | c2     |    139620864026200 | RECORD  | X,GAP   | GRANTED   | 8, 0x000000001715 |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-------------------+
2 rows in set (0.00 sec)
 
 
```

### 主键上等值查询+范围，记录不存在：范围里存在的上nextkey lock，直到最大虚拟值。

```
mysql> show create table t1 \G
*************************** 1. row ***************************
Table: t1
Create Table: CREATE TABLE `t1` (
`c1` int unsigned NOT NULL DEFAULT '0',
`c2` int unsigned NOT NULL DEFAULT '0',
`c3` int unsigned NOT NULL DEFAULT '0',
`c4` int unsigned NOT NULL DEFAULT '0',
PRIMARY KEY (`c1`),
KEY `c2` (`c2`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)

mysql> select * from t1;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
|  1 |  1 |  1 |  0 |
|  3 |  3 |  3 |  0 |
|  6 |  6 |  5 |  0 |
|  8 |  8 |  8 |  8 |
| 10 |  4 |  4 |  0 |
+----+----+----+----+
6 rows in set (0.00 sec)

mysql> begin ; select * from t1 where c1 >= 5 for update;
Query OK, 0 rows affected (0.00 sec)

+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
|  6 |  6 |  5 |  0 |
|  8 |  8 |  8 |  8 |
| 10 |  4 |  4 |  0 |
+----+----+----+----+
3 rows in set (0.00 sec)

mysql>  select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 139620969519720:1073:139620864029240   |                  2733 |       103 |      673 | kk            | t1          | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX        | GRANTED     | NULL                   |
| INNODB | 139620969519720:16:4:1:139620864026200 |                  2733 |       103 |      673 | kk            | t1          | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X         | GRANTED     | supremum pseudo-record |
| INNODB | 139620969519720:16:4:6:139620864026200 |                  2733 |       103 |      673 | kk            | t1          | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X         | GRANTED     | 6                      |
| INNODB | 139620969519720:16:4:8:139620864026200 |                  2733 |       103 |      673 | kk            | t1          | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X         | GRANTED     | 10                     |
| INNODB | 139620969519720:16:4:9:139620864026200 |                  2733 |       103 |      673 | kk            | t1          | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X         | GRANTED     | 8                      |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
5 rows in set (0.00 sec)

mysql> insert into t1 values(5,7,7,7);
mysql> select ENGINE_LOCK_ID,ENGINE_TRANSACTION_ID,INDEX_NAME  ,OBJECT_INSTANCE_BEGIN,LOCK_TYPE,LOCK_MODE,LOCK_STATUS,LOCK_DATA from performance_schema.data_locks;
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
| ENGINE_LOCK_ID                        | ENGINE_TRANSACTION_ID | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE              | LOCK_STATUS | LOCK_DATA    
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
| 139804952604112:1059:139804876540280  |                  1583 | NULL       |       139804876540280 | TABLE     | IX                     | GRANTED     | NULL         
| 139804952604112:2:4:5:139804876537352 |                  1583 | PRIMARY    |       139804876537352 | RECORD    | X,GAP,INSERT_INTENTION | WAITING     | 6            
| 139804952603240:1059:139804876534328  |                  1582 | NULL       |       139804876534328 | TABLE     | IX                     | GRANTED     | NULL         
| 139804952603240:2:4:1:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | supremum pseu
| 139804952603240:2:4:5:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 6            
| 139804952603240:2:4:6:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 8            
| 139804952603240:2:4:7:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 10           
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
7 rows in set (0.00 sec)

mysql> insert into t1 values(4,7,7,7);
mysql> select ENGINE_LOCK_ID,ENGINE_TRANSACTION_ID,INDEX_NAME  ,OBJECT_INSTANCE_BEGIN,LOCK_TYPE,LOCK_MODE,LOCK_STATUS,LOCK_DATA from performance_schema.data_locks;
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
| ENGINE_LOCK_ID                        | ENGINE_TRANSACTION_ID | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE              | LOCK_STATUS | LOCK_DATA    
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
| 139804952604112:1059:139804876540280  |                  1584 | NULL       |       139804876540280 | TABLE     | IX                     | GRANTED     | NULL         
| 139804952604112:2:4:5:139804876537352 |                  1584 | PRIMARY    |       139804876537352 | RECORD    | X,GAP,INSERT_INTENTION | WAITING     | 6            
| 139804952603240:1059:139804876534328  |                  1582 | NULL       |       139804876534328 | TABLE     | IX                     | GRANTED     | NULL         
| 139804952603240:2:4:1:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | supremum pseu
| 139804952603240:2:4:5:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 6            
| 139804952603240:2:4:6:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 8            
| 139804952603240:2:4:7:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 10           
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
7 rows in set (0.00 sec)

mysql> insert into t1 values(9,7,7,7);
mysql> select ENGINE_LOCK_ID,ENGINE_TRANSACTION_ID,INDEX_NAME  ,OBJECT_INSTANCE_BEGIN,LOCK_TYPE,LOCK_MODE,LOCK_STATUS,LOCK_DATA from performance_schema.data_locks;
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
| ENGINE_LOCK_ID                        | ENGINE_TRANSACTION_ID | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE              | LOCK_STATUS | LOCK_DATA    
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
| 139804952604112:1059:139804876540280  |                  1587 | NULL       |       139804876540280 | TABLE     | IX                     | GRANTED     | NULL         
| 139804952604112:2:4:7:139804876537352 |                  1587 | PRIMARY    |       139804876537352 | RECORD    | X,GAP,INSERT_INTENTION | WAITING     | 10           
| 139804952603240:1059:139804876534328  |                  1582 | NULL       |       139804876534328 | TABLE     | IX                     | GRANTED     | NULL         
| 139804952603240:2:4:1:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | supremum pseu
| 139804952603240:2:4:5:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 6            
| 139804952603240:2:4:6:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 8            
| 139804952603240:2:4:7:139804876531288 |                  1582 | PRIMARY    |       139804876531288 | RECORD    | X                      | GRANTED     | 10           
+---------------------------------------+-----------------------+------------+-----------------------+-----------+------------------------+-------------+--------------
7 rows in set (0.00 sec)
```

### 主键索引，范围查询，值不存在：下一个值前gap上锁

```
mysql> select * from t1;
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 1 | 1 | 1 | 0 |
| 3 | 3 | 3 | 0 |
-----------------------
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
5 rows in set (0.00 sec)
 
 
mysql> begin ; select * from t1 where c1 > 4 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
3 rows in set (0.00 sec)
 
mysql> begin ; insert into t1 select 4,4,4,4;
Query OK, 0 rows affected (0.00 sec)
--hang
 
 
说明c1 = 6 前有gap lock ， 无法插入意向插入锁。
mysql> begin ; select * from t1 where c1 > 5 for update;
Query OK, 0 rows affected (0.00 sec)
 
+----+----+----+----+
| c1 | c2 | c3 | c4 |
+----+----+----+----+
| 6 | 6 | 5 | 0 |
| 8 | 8 | 8 | 8 |
| 10 | 4 | 4 | 0 |
+----+----+----+----+
3 rows in set (0.00 sec)
 
mysql> begin ; insert into t1 select 4,4,4,4;
Query OK, 0 rows affected (0.00 sec)
--hang
 
mysql> select * from performance_schema.data_locks;
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE       | LOCK_STATUS | LOCK_DATA       |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+------------------------+
| INNODB | 139620969520592:1073:139620864035192  |         2746 |    104 |   109 | kk      | t1     | NULL      | NULL       | NULL    |    139620864035192 | TABLE   | IX           | GRANTED   | NULL          |
| INNODB | 139620969520592:16:4:6:139620864032264 |         2746 |    104 |   109 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864032264 | RECORD  | X,GAP,INSERT_INTENTION | WAITING   | 6           |
| INNODB | 139620969519720:1073:139620864029240  |         2745 |    103 |   693 | kk      | t1     | NULL      | NULL       | NULL    |    139620864029240 | TABLE   | IX           | GRANTED   | NULL          |
| INNODB | 139620969519720:16:4:1:139620864026200 |         2745 |    103 |   693 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X           | GRANTED   | supremum pseudo-record |
| INNODB | 139620969519720:16:4:6:139620864026200 |         2745 |    103 |   693 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X           | GRANTED   | 6           |
| INNODB | 139620969519720:16:4:8:139620864026200 |         2745 |    103 |   693 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X           | GRANTED   | 10           |
| INNODB | 139620969519720:16:4:9:139620864026200 |         2745 |    103 |   693 | kk      | t1     | NULL      | NULL       | PRIMARY  |    139620864026200 | RECORD  | X           | GRANTED   | 8           |
+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+------------------------+
7 rows in set (0.00 sec)
```