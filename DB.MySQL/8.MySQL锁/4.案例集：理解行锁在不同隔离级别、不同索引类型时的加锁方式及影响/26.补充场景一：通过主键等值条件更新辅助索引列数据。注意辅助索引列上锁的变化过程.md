[TOC]

# 补充场景一：通过主键等值条件更新辅助索引列数据。注意辅助索引列上锁的变化过程

- 表结构

  ```
  mysql> show create table t \G
  *************************** 1. row ***************************
         Table: t
  Create Table: CREATE TABLE `t` (
    `c1` int NOT NULL,
    `c2` int DEFAULT NULL,
    `c3` int DEFAULT NULL,
    `c4` int DEFAULT NULL,
    PRIMARY KEY (`c1`),
    UNIQUE KEY `c2` (`c2`),
    KEY `c3` (`c3`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
  1 row in set (0.00 sec)
  
  mysql> select * from t;
  +----+------+------+------+
  | c1 | c2   | c3   | c4   |
  +----+------+------+------+
  Infimum                       <- heap no:0
  Supermum                      <- heap no:1
  |  1 |    1 |    1 |    1 |   <- heap no:2
  | 10 |   10 |   10 |   10 |   <- heap no:3
  | 20 |   20 |   20 |   20 |   <- heap no:4
  | 30 |   30 |   30 |   30 |   <- heap no:5
  +----+------+------+------+
  4 rows in set (0.00 sec)
  
  ```


## 场景

| t1                                                           | t2                                                           |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| begin ;<br>mysql> begin ; update t set c3 = 2 where c1 = 1; Query OK, 0 rows affected (0.00 sec) | begin ;                                                      |
|                                                              | mysql> begin ; update t set c3 = 2 where c3 = 2; Query OK, 0 rows affected (0.00 sec) |

### 结果：对辅助索引进行更新时，会对索引原有值和新值加<font color=red>REC_NOT_GAP锁</font>，直到更新完成。

## 过程

1. t1

   ```
   mysql> begin ; update t set c3 = 2 where c1 = 1;
   Query OK, 0 rows affected (0.00 sec)
   
   Query OK, 1 row affected (0.01 sec)
   Rows matched: 1  Changed: 1  Warnings: 0
   ```
   
   - c1 = 1 为主键，加 rec_not_gap| S， 由于是update操作，获取后转为rec_not_gap|lock_x 排他锁；
   - 同时，c1 = 1 行的 c3 值  c3 = 1 需要被更新，加排他锁 rec_not_gap| X，更新。
   
2. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | INNODB | 139620969519720:1076:139620864029240   |                  2438 |        99 |       84 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX            | GRANTED     | NULL      |
   | INNODB | 139620969519720:19:4:2:139620864026200 |                  2438 |        99 |       84 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   2 rows in set (0.00 sec)
   ```
   
   - 因为更新没有真正成功，因此数据行C3的索引还持有锁，
   - 但是这里发现，c3 = 2(1)上的记录排他锁rec_not_gap 查询不到，因为更新操作没真正的成功，因此锁是隐式的。那就让隐式的锁显示出来。
   
3. t2

   ```
   mysql> begin ; update t set c3 = 2 where c3 = 2;
   Query OK, 0 rows affected (0.00 sec)
   ```
   
   - 对c3 = 2 进行锁，让隐式的锁现形。
   
4. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | INNODB | 139620969520592:1076:139620864035192   |                  2440 |       100 |       44 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX            | GRANTED     | NULL      |
   | INNODB | 139620969520592:19:6:6:139620864032264 |                  2440 |       100 |       44 | kk            | t           | NULL           | NULL              | c3  ***    |       139620864032264 | RECORD**  | X             | WAITING *** | 2, 1      | *****
   | INNODB | 139620969519720:1076:139620864029240   |                  2438 |        99 |       84 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX            | GRANTED     | NULL      |
   | INNODB | 139620969519720:19:4:2:139620864026200 |                  2438 |        99 |       84 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |
   | INNODB | 139620969519720:19:6:6:139620864026544 |                  2438 |       100 |       44 | kk            | t           | NULL           | NULL              | c3         |       139620864026544 | RECORD    | X,REC_NOT_GAP | GRANTED     | 2, 1      |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   5 rows in set (0.00 sec)
   
   mysql> begin ; update t set c3 = 2 where c3 = 1;
   Query OK, 0 rows affected (0.00 sec)
   
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | INNODB | 139620969520592:1076:139620864035192   |                  2441 |       100 |       47 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX            | GRANTED     | NULL      |
   | INNODB | 139620969520592:19:6:2:139620864032264 |                  2441 |       100 |       47 | kk            | t           | NULL           | NULL              | c3    ***  |       139620864032264 | RECORD ** | X             | WAITING **  | 1, 1    **| **
   | INNODB | 139620969519720:1076:139620864029240   |                  2438 |        99 |       84 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX            | GRANTED     | NULL      |
   | INNODB | 139620969519720:19:4:2:139620864026200 |                  2438 |        99 |       84 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |
   | INNODB | 139620969519720:19:6:2:139620864026544 |                  2438 |       100 |       44 | kk            | t           | NULL           | NULL              | c3    ***  |       139620864026544 | RECORD ** | X,REC_NOT_GAP | GRANTED **  | 1, 1    **| **
   | INNODB | 139620969519720:19:6:6:139620864026544 |                  2438 |       100 |       44 | kk            | t           | NULL           | NULL              | c3    ***  |       139620864026544 | RECORD ** | X,REC_NOT_GAP | GRANTED **  | 2, 1    **| **
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   6 rows in set (0.00 sec)
   ```
   
   - 现形成功。可以发现，对辅助索引进行更新时，会对索引原有值和新值加REC_NOT_GAP锁，直到更新完成。

> c1=1 主键上rec_not_gap | lock_X
> c1=1的记录的c3要被更新， c3=1 上 rec_not_gap | lock_X
> c3=2上rec_not_gap | lock_X
> 此时没成功更新，对c3=2上的隐式锁。



实验一下，先对辅助索引更新目标值上锁，再尝试通过主键条件更新辅助索引列值。

1. t1

   ```
   mysql> begin ; select * from t where c3 = 2 for update;
   Query OK, 0 rows affected (0.00 sec)
   ```

2. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   | INNODB | 139620969520592:1076:139620864035192   |                  2443 |       100 |       50 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX        | GRANTED     | NULL      |
   | INNODB | 139620969520592:19:6:3:139620864032264 |                  2443 |       100 |       50 | kk            | t           | NULL           | NULL              | c3         |       139620864032264 | RECORD    | X,GAP     | GRANTED     | 10, 10    |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   2 rows in set (0.00 sec)
   
   ```

3. t2

   ```
   mysql> begin ; update t set c3 = 2 where c1 = 1;
   Query OK, 0 rows affected (0.00 sec)
   ```

4. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE              | LOCK_STATUS | LOCK_DATA |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
   | INNODB | 139620969519720:1076:139620864029240   |                  2444 |        99 |       88 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX                     | GRANTED     | NULL      |
   | INNODB | 139620969519720:19:4:2:139620864026200 |                  2444 |        99 |       88 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP          | GRANTED     | 1         |
   | INNODB | 139620969519720:19:6:3:139620864026544 |                  2444 |        99 |       88 | kk            | t           | NULL           | NULL              | c3    ***  |       139620864026544 | RECORD ** | X,GAP,INSERT_INTENTION*| WAITING  ** | 10, 10    | ***
   | INNODB | 139620969520592:1076:139620864035192   |                  2443 |       100 |       50 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX                     | GRANTED     | NULL      |
   | INNODB | 139620969520592:19:6:3:139620864032264 |                  2443 |       100 |       50 | kk            | t           | NULL           | NULL              | c3         |       139620864032264 | RECORD    | X,GAP                  | GRANTED     | 10, 10    |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
   5 rows in set (0.00 sec)
   ```

   - 主键ec_not_gap锁，辅助索引列下一值gap插入意向锁，以更新新值。



辅助实验一下，可以看到，对辅助索引原有记录值也会上锁。

1. t1

   ```
   mysql> begin ; update t set c3 = 2 where c1 = 1;
   Query OK, 0 rows affected (0.00 sec)
   
   Query OK, 1 row affected (0.00 sec)
   Rows matched: 1  Changed: 1  Warnings: 0
   
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | INNODB | 139620969519720:1076:139620864029240   |                  2452 |        99 |      102 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX            | GRANTED     | NULL      |
   | INNODB | 139620969519720:19:4:2:139620864026200 |                  2452 |        99 |      102 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   2 rows in set (0.00 sec)
   ```

2. t2

   ```
   mysql> begin ; update t set c3 = 1 where c3 = 1;
   Query OK, 0 rows affected (0.00 sec)
   ```

3. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   | INNODB | 139620969520592:1076:139620864035192   |                  2457 |       100 |       58 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX            | GRANTED     | NULL      |
   | INNODB | 139620969520592:19:6:2:139620864032264 |                  2457 |       100 |       58 | kk            | t           | NULL           | NULL              | c3   **    |       139620864032264 | RECORD ** | X     **      | WAITING **  | 1, 1  **  |  ****
   | INNODB | 139620969519720:1076:139620864029240   |                  2452 |        99 |      102 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX            | GRANTED     | NULL      |
   | INNODB | 139620969519720:19:4:2:139620864026200 |                  2452 |        99 |      102 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |
   | INNODB | 139620969519720:19:6:2:139620864026544 |                  2452 |       100 |       58 | kk            | t           | NULL           | NULL              | c3         |       139620864026544 | RECORD    | X,REC_NOT_GAP | GRANTED     | 1, 1      |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
   5 rows in set (0.00 sec)
   ```

   
