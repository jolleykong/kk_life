[TOC]

# 补充场景二：主键上范围条件加锁，大于等于，唯一索引的大于等于范围条件加锁时，对等值条件加rec_not_gap，再对范围加ordinary

- 表结构

  ```
  mysql> show create table t \G
  *************************** 1. row ***************************
         Table: t
  Create Table: CREATE TABLE `t` (
    `c1` int NOT NULL,
    `c2` int DEFAULT NULL,
    `c3` int DEFAULT NULL,
    `c4` int DEFAULT NULL,
    PRIMARY KEY (`c1`),
    UNIQUE KEY `c2` (`c2`),
    KEY `c3` (`c3`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
  1 row in set (0.00 sec)
  
  
  mysql> select * from t;
  +----+------+------+------+
  | c1 | c2   | c3   | c4   |
  +----+------+------+------+
  Infimum                       <- heap no:0
  Supermum                      <- heap no:1
  |  1 |    1 |    1 |    1 |   <- heap no:2
  | 10 |   10 |   10 |   10 |   <- heap no:3
  | 20 |   20 |   20 |   20 |   <- heap no:4
  | 30 |   30 |   30 |   30 |   <- heap no:5
  +----+------+------+------+
  4 rows in set (0.00 sec)
  
  ```


## 场景

| t1                                                    |
| ----------------------------------------------------- |
| begin ;<br>select * from t where c1 >= 20 for update; |

### 结果：大于等于情况：对c1 = 20 加 lock_rec_not_gap | lock_X，再对c1 > 20 加 lock_ordinary | lock_X。

## 过程

1. t1

   ```
   mysql> begin ; select * from t where c1 >= 20 for update;
   Query OK, 0 rows affected (0.00 sec)
   
   +----+------+------+------+
   | c1 | c2   | c3   | c4   |
   +----+------+------+------+
   | 20 |   20 |   20 |   20 |
   | 30 |   30 |   30 |   30 |
   +----+------+------+------+
   2 rows in set (0.00 sec)
   ```

2. t3

   ```
   mysql> select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+----------------+-------------+------------------------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OLOCK_MODE     | LOCK_STATUS | LOCK_DATA              |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+----------------+-------------+------------------------+
   | INNODB | 139620969519720:1076:139620864029240   |                  2459 |        99 |      110 | kk            | tIX            | GRANTED     | NULL                   |
   | INNODB | 139620969519720:19:4:4:139620864026200 |                  2459 |        99 |      110 | kk            | tX,REC_NOT_GAP | GRANTED     | 20                     |
   | INNODB | 139620969519720:19:4:1:139620864026544 |                  2459 |        99 |      110 | kk            | tX             | GRANTED     | supremum pseudo-record |
   | INNODB | 139620969519720:19:4:5:139620864026544 |                  2459 |        99 |      110 | kk            | tX             | GRANTED     | 30                     |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+----------------+-------------+------------------------+
   4 rows in set (0.00 sec)
   ```

   - 有隐式锁，下面让它们现形。

3. t2

   ```
   mysql> begin ; insert into t values (21,21,21,21);
   Query OK, 0 rows affected (0.00 sec)
   --hang
   ```

4. t3

   ```
   mysql> select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+------------------------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE              | LOCK_STATUS | LOCK_DATA              |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+------------------------+
   | INNODB | 139620969520592:1076:139620864035192   |                  2460 |       100 |       62 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX                     | GRANTED     | NULL                   |
   | INNODB | 139620969520592:19:4:5:139620864032264 |                  2460 |       100 |       62 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864032264 | RECORD    | X,GAP,INSERT_INTENTION | WAITING     | 30                     |
   | INNODB | 139620969519720:1076:139620864029240   |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX                     | GRANTED     | NULL                   |
   | INNODB | 139620969519720:19:4:4:139620864026200 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP          | GRANTED     | 20                     |
   | INNODB | 139620969519720:19:4:1:139620864026544 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026544 | RECORD    | X                      | GRANTED     | supremum pseudo-record |
   | INNODB | 139620969519720:19:4:5:139620864026544 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026544 | RECORD    | X                      | GRANTED     | 30                     |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+------------------------+
   6 rows in set (0.00 sec)
   ```

   - 范围条件，且等值条件存在， 因此对等值条件上rec_not_gap锁，对范围直到最大虚拟值上ordinary lock
   - 21处于已存在值20和30之间，插入21需要向值30前的gap进行插入意向锁，但是从20开始的记录都上了ordinary lock ，所以对意向插入锁和gap冲突，被阻塞。

5. t2

   ```
   mysql> begin ; select * from t where c1 = 19 for update;
   Query OK, 0 rows affected (0.00 sec)
   
   Empty set (0.00 sec)
   ```

6. t3

   ```
   mysql> mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   | INNODB | 139620969520592:1076:139620864035192   |                  2461 |       100 |       65 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX            | GRANTED     | NULL                   |
   | INNODB | 139620969520592:19:4:4:139620864032264 |                  2461 |       100 |       65 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864032264 | RECORD    | X,GAP         | GRANTED     | 20                     |
   | INNODB | 139620969519720:1076:139620864029240   |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX            | GRANTED     | NULL                   |
   | INNODB | 139620969519720:19:4:4:139620864026200 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 20                     |
   | INNODB | 139620969519720:19:4:1:139620864026544 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026544 | RECORD    | X             | GRANTED     | supremum pseudo-record |
   | INNODB | 139620969519720:19:4:5:139620864026544 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026544 | RECORD    | X             | GRANTED     | 30                     |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   6 rows in set (0.00 sec)
   ```

   - 可以看到，对等值条件前的gap是不加锁的。

7. t2

   ```
   mysql> mysql> begin ; select * from t where c1 = 20 for update;
   Query OK, 0 rows affected (0.00 sec)
   --hang
   ```

8. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   | INNODB | 139620969520592:1076:139620864035192   |                  2462 |       100 |       68 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX            | GRANTED     | NULL                   |
   | INNODB | 139620969520592:19:4:4:139620864032264 |                  2462 |       100 |       68 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864032264 | RECORD    | X,REC_NOT_GAP | WAITING     | 20                     |
   | INNODB | 139620969519720:1076:139620864029240   |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX            | GRANTED     | NULL                   |
   | INNODB | 139620969519720:19:4:4:139620864026200 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 20                     |
   | INNODB | 139620969519720:19:4:1:139620864026544 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026544 | RECORD    | X             | GRANTED     | supremum pseudo-record |
   | INNODB | 139620969519720:19:4:5:139620864026544 |                  2459 |        99 |      110 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026544 | RECORD    | X             | GRANTED     | 30                     |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   6 rows in set (0.00 sec)
   ```

   - 可以看到对等值条件上的rec_not_gap锁。



验证一下对等值先ordinary再退化成rec_not_gap：结论:对于等值并不上ordinary lock。

1. t1

   ```
   mysql> begin ; select * from t where c1 = 19 for update;
   Query OK, 0 rows affected (0.00 sec)
   
   Empty set (0.00 sec)
   ```

2. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   | INNODB | 139620969519720:1076:139620864029240   |                  2463 |        99 |      114 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX        | GRANTED     | NULL      |
   | INNODB | 139620969519720:19:4:4:139620864026200 |                  2463 |        99 |      114 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,GAP     | GRANTED     | 20        |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   2 rows in set (0.00 sec)
   ```

3. t2

   ```
   mysql> begin  ; select * from t where c1 >= 20 for update;
   Query OK, 0 rows affected (0.00 sec)
   
   +----+------+------+------+
   | c1 | c2   | c3   | c4   |
   +----+------+------+------+
   | 20 |   20 |   20 |   20 |
   | 30 |   30 |   30 |   30 |
   +----+------+------+------+
   2 rows in set (0.00 sec)
   ```

   - 顺利执行，说明并没对等值先ordinary再退化。

4. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   | ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   | INNODB | 139620969520592:1076:139620864035192   |                  2464 |       100 |       72 | kk            | t           | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX            | GRANTED     | NULL                   |
   | INNODB | 139620969520592:19:4:4:139620864032264 |                  2464 |       100 |       72 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864032264 | RECORD    | X,REC_NOT_GAP | GRANTED     | 20                     |
   | INNODB | 139620969520592:19:4:1:139620864032608 |                  2464 |       100 |       72 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864032608 | RECORD    | X             | GRANTED     | supremum pseudo-record |
   | INNODB | 139620969520592:19:4:5:139620864032608 |                  2464 |       100 |       72 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864032608 | RECORD    | X             | GRANTED     | 30                     |
   | INNODB | 139620969519720:1076:139620864029240   |                  2463 |        99 |      114 | kk            | t           | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX            | GRANTED     | NULL                   |
   | INNODB | 139620969519720:19:4:4:139620864026200 |                  2463 |        99 |      114 | kk            | t           | NULL           | NULL              | PRIMARY    |       139620864026200 | RECORD    | X,GAP         | GRANTED     | 20                     |
   +--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
   6 rows in set (0.00 sec)
   
   ```






## InnoDB 行锁兼容性

|                |                       | 请求的锁类型  | 请求的锁类型     | 请求的锁类型 | 请求的锁类型          |
| -------------- | --------------------- | ------------- | ---------------- | ------------ | --------------------- |
|                |                       | lock_ordinary | lock_rec_not_gap | lock_gap     | lock_insert_intention |
| 已获得的锁类型 | lock_ordinary         | X             | X                | O            | X                     |
| 已获得的锁类型 | lock_rec_not_gap      | X             | X                | O            | O                     |
| 已获得的锁类型 | lock_gap              | O             | O                | O            | X                     |
| 已获得的锁类型 | lock_insert_intention | O             | O                | O            | O                     |

 - gap只和insert intention锁冲突
  - insert intention和任何锁都不冲突，除非也在相同位置做意向插入锁


 - 先获得意向插入锁的，再尝试上gap lock是可以的
  - 但是反过来 ，先获得gap lock的，再尝试加上意向插入锁便会阻塞，
  - 原因是：先获得意向插入锁时，实际上插入已经成功，意向插入锁会被转变为对具体记录的ordinary 或 rec_not_gap ，此时二者都与lock gap兼容。

