[TOC]

# 场景二十五：通过不存在的辅助索引条件等值上X锁，再通过主键条件更新辅助索引列值（场景二十四的反序）

- 表结构

  ```
  mysql> show create table t1 \G
  *************************** 1. row ***************************
         Table: t1
  Create Table: CREATE TABLE `t1` (
    `c1` int unsigned NOT NULL DEFAULT '0',
    `c2` int unsigned NOT NULL DEFAULT '0',
    `c3` int unsigned NOT NULL DEFAULT '0',
    `c4` int unsigned NOT NULL DEFAULT '0',
    PRIMARY KEY (`c1`),
    KEY `c2` (`c2`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
  1 row in set (0.00 sec)
  
  mysql> select * from t1;
  +----+----+----+----+
  | c1 | c2 | c3 | c4 |
  +----+----+----+----+
  |  0 |  0 |  0 |  0 |
  |  1 |  1 |  1 |  0 |
  |  3 |  3 |  3 |  0 |
  |  4 |  2 |  2 |  0 |
  |  6 |  2 |  5 |  0 |
  |  8 |  6 |  6 |  0 |
  |  9 |  9 |  9 |  9 |*
  | 10 |  4 |  4 |  0 |
  +----+----+----+----+
  7 rows in set (0.00 sec)
  
  ```


## 场景

| t1                                                   | t2                                 |
| ---------------------------------------------------- | ---------------------------------- |
| begin ;<br>select * from t1 where c2 = 7 for update; | begin ;                            |
|                                                      | update t1 set c2 = 8 where c1 = 1; |

### 结果：<font color=red>阻塞。</font>

## 过程

1. t1

   ```
   mysql> begin ; select * from t1 where c2 = 7  for update;
   Query OK, 0 rows affected (0.00 sec)
   
   Empty set (0.00 sec)
   ```
   
   - 这会在(9,9,9,9)这一行上发生锁，具体发生在c2=9的gap上，因为c2没有7，那么就在下一个值9前面的gap上锁。
   
2. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+-----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                          | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
   +--------+-----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   | INNODB | 139620969519720:1073:139620864029240    |                  2359 |        95 |       66 | kk            | t1          | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX        | GRANTED     | NULL      |
   | INNODB | 139620969519720:16:5:10:139620864026200 |                  2359 |        95 |       66 | kk            | t1          | NULL           | NULL              | c2         |       139620864026200 | RECORD    | X,GAP     | GRANTED     | 9, 9      | ****
   +--------+-----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
   2 rows in set (0.00 sec)
   ```
   
   - 查看可以验证前面说的，因为c2没有7，那么就在下一个值9前面的gap上锁。
   
3. t2

   ```
   mysql> begin  ; update t1 set c2=8 where c1 = 1;
   Query OK, 0 rows affected (0.00 sec)
   --hang
   ```
   
4. t3

   ```
   mysql>  select * from performance_schema.data_locks;
   +--------+-----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
   | ENGINE | ENGINE_LOCK_ID                          | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE              | LOCK_STATUS | LOCK_DATA |
   +--------+-----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
   | INNODB | 139620969520592:1073:139620864035192    |                  2360 |        96 |       54 | kk            | t1          | NULL           | NULL              | NULL       |       139620864035192 | TABLE     | IX                     | GRANTED     | NULL      |
   | INNODB | 139620969520592:16:4:3:139620864032264  |                  2360 |        96 |       54 | kk            | t1          | NULL           | NULL              | PRIMARY    |       139620864032264 | RECORD    | X,REC_NOT_GAP          | GRANTED     | 1         |
   | INNODB | 139620969520592:16:5:10:139620864032608 |                  2360 |        96 |       54 | kk            | t1          | NULL           | NULL              | c2         |       139620864032608 | RECORD    | X,GAP,INSERT_INTENTION | WAITING     | 9, 9      |
   | INNODB | 139620969519720:1073:139620864029240    |                  2359 |        95 |       66 | kk            | t1          | NULL           | NULL              | NULL       |       139620864029240 | TABLE     | IX                     | GRANTED     | NULL      |
   | INNODB | 139620969519720:16:5:10:139620864026200 |                  2359 |        95 |       66 | kk            | t1          | NULL           | NULL              | c2         |       139620864026200 | RECORD    | X,GAP                  | GRANTED     | 9, 9      |
   +--------+-----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+
   5 rows in set (0.00 sec)
   ```
   
   - <font color=red>同样，要更新c2=8 ，可以发现c2没有8的记录，按照顺序也是在下一个值，也就是c2=9前的gap加插入意向锁，这就和刚才的gap冲突了。</font>