> 复制管理技能：
>
> ​	1.复制架构调整
>
> ​	2.在线最小影响添加新的slave
>
> ​	3.复制延迟的排查和处理
>
> ​	**4.保证主从数据一致性**
>
> ​	5.利用主从架构实现数据快速闪回

[TOC]


# 主从数据一致性校验

使用percona pt-table-checksum工具

## 安装percona pt-table-checksum

```
yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm

yum install percona-toolkit
```

> https://www.percona.com/software/database-tools/percona-toolkit
>
> https://www.percona.com/doc/percona-toolkit/LATEST/installation.html



## pt-table-checksum对端口敏感

1. 这个玩意对端口蜜汁敏感，如果主从用的端口不一致，可能会有问题。
2. 说下主从架构的约定俗成——主从实例运行在不同服务器上（或者说，在不同宿主机上），至于一个服务器上跑多个**instance**并在这些**instance**之间进行主从配置，没这么干的。
3. 如果非按2那么干，那么这个工具跑不起来，反正结果不对（也许是因为1的原因，哈哈，反正一个机器上多个实例端口肯定不一致嘛！）。
4. 坑死我了，破玩意，困扰了我近2天的时间。



## pt-table-checksum语法

pt-table-checksum 

| --recursion-method="processlist"  \ | 获取slave的方式                                  |
| ----------------------------------- | ------------------------------------------------ |
| --replicate="kk.ck"  \              | checksum的结果放哪个表里                         |
| --host='192.168.188.101'  \         | master的ip                                       |
| --port=3306  \                      | master的port                                     |
| --user='chk'  \                     | 检查用的用户，要求有权限，而且要求各节点都能使用 |
| --password='chk'  \                 | 检查用的用户的密码                               |
| --databases=kk  \                   | 要校验的数据库                                   |
| --no-check-binlog-format            |                                                  |

 

## 权限需求

```
我懒…… 
mysql> show grants for 'chk'@'%';
+------------------------------------------+
| Grants for chk@%             |
+------------------------------------------+
| GRANT ALL PRIVILEGES ON *.* TO 'chk'@'%' |
+------------------------------------------+
1 row in set (0.00 sec)
```




## 使用 pt-table-checksum 做主从校验

```
[root@mysqlvm1 logs]# pt-table-checksum --recursion-method="processlist" --replicate="kk.ck" --host='192.168.188.101' --port=3306 --user='chk' --password='chk' --databases=kk --no-check-binlog-format
Checking if all tables can be checksummed ...
Starting checksum ...
      TS ERRORS DIFFS   ROWS DIFF_ROWS CHUNKS SKIPPED  TIME TABLE
03-06T15:13:42   0   1  10689     0    4    0  0.440 kk.tb1
```



## pt-table-checksum原理分析

- master:
    ```
    mysqld, Version: 5.7.26-log (MySQL Community Server (GPL)). started with:
    Tcp port: 3306 Unix socket: /data/mysql/mysql3306/tmp/mysql.sock
    Time         Id Command  Argument
    2020-03-06T14:43:37.077642+08:00    10768 Connect    chk@192.168.188.101 on using TCP/IP
    2020-03-06T14:43:37.078104+08:00    10768 Query    SHOW VARIABLES LIKE 'innodb\_lock_wait_timeout'
    2020-03-06T14:43:37.079467+08:00    10768 Query    SET SESSION innodb_lock_wait_timeout=1
    2020-03-06T14:43:37.079684+08:00    10768 Query    SHOW VARIABLES LIKE 'wait\_timeout'
    2020-03-06T14:43:37.080555+08:00    10768 Query    SET SESSION wait_timeout=10000
    2020-03-06T14:43:37.080667+08:00    10768 Query    SELECT @@SQL_MODE
    2020-03-06T14:43:37.080839+08:00    10768 Query    SET @@SQL_QUOTE_SHOW_CREATE = 1/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'*/
    2020-03-06T14:43:37.080991+08:00    10768 Query    SELECT @@server_id /*!50038 , @@hostname*/
    2020-03-06T14:43:37.081127+08:00    10768 Query    SELECT @@SQL_MODE
    2020-03-06T14:43:37.081212+08:00    10768 Query    SET SQL_MODE=',NO_AUTO_VALUE_ON_ZERO,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'
    2020-03-06T14:43:37.081349+08:00    10768 Query    SHOW VARIABLES LIKE 'version%'
    2020-03-06T14:43:37.082349+08:00    10768 Query    SHOW ENGINES
    2020-03-06T14:43:37.082612+08:00    10768 Query    SHOW VARIABLES LIKE 'innodb_version'
    2020-03-06T14:43:37.083689+08:00    10768 Query    SELECT @@binlog_format
    2020-03-06T14:43:37.083863+08:00    10768 Query    /*!50108 SET @@binlog_format := 'STATEMENT'*/
    ↑--这个很重要，statement的时候，slave也会同步计算自己的值（在后面update和replace阶段）

    2020-03-06T14:43:37.083943+08:00    10768 Query    SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
    2020-03-06T14:43:37.084285+08:00    10768 Query    SHOW /*!40103 GLOBAL*/ VARIABLES
    2020-03-06T14:43:37.086135+08:00    10768 Query    SELECT VERSION()
    2020-03-06T14:43:37.086399+08:00    10768 Query    SHOW ENGINES
    2020-03-06T14:43:37.087067+08:00    10768 Query    SHOW VARIABLES LIKE 'wsrep_on'
    2020-03-06T14:43:37.088434+08:00    10768 Query    SELECT @@SERVER_ID
    2020-03-06T14:43:37.088613+08:00    10768 Query    SHOW GRANTS FOR CURRENT_USER()
    2020-03-06T14:43:37.088770+08:00    10768 Query    SHOW FULL PROCESSLIST
    2020-03-06T14:43:37.120552+08:00    10768 Query    SHOW VARIABLES LIKE 'wsrep_on'
    2020-03-06T14:43:37.122940+08:00    10768 Query    SELECT @@SERVER_ID
    2020-03-06T14:43:37.131440+08:00    10768 Query    SHOW VARIABLES LIKE 'wsrep_on'
    2020-03-06T14:43:37.133113+08:00    10768 Query    SELECT @@SERVER_ID
    2020-03-06T14:43:37.150602+08:00    10768 Query    SHOW DATABASES LIKE 'kk'
    2020-03-06T14:43:37.150931+08:00    10768 Query    CREATE DATABASE IF NOT EXISTS `kk` /* pt-table-checksum */

    2020-03-06T14:43:37.161569+08:00    10768 Query    USE `kk`

    2020-03-06T14:43:37.161895+08:00    10768 Query    SHOW TABLES FROM `kk` LIKE 'ck'
    2020-03-06T14:43:37.163705+08:00    10768 Query    CREATE TABLE IF NOT EXISTS `kk`.`ck` (
       db       CHAR(64)   NOT NULL,
       tbl      CHAR(64)   NOT NULL,
       chunk     INT     NOT NULL,
       chunk_time   FLOAT      NULL,
       chunk_index  VARCHAR(200)   NULL,
       lower_boundary TEXT       NULL,
       upper_boundary TEXT       NULL,
       this_crc    CHAR(40)   NOT NULL,
       this_cnt    INT     NOT NULL,
       master_crc   CHAR(40)     NULL,
       master_cnt   INT       NULL,
       ts       TIMESTAMP  NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
       PRIMARY KEY (db, tbl, chunk),
       INDEX ts_db_tbl (ts, db, tbl)
     ) ENGINE=InnoDB DEFAULT CHARSET=utf8
    2020-03-06T14:43:37.175634+08:00    10768 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
    2020-03-06T14:43:37.176604+08:00    10768 Query    SELECT CONCAT(@@hostname, @@port)
    2020-03-06T14:43:37.177772+08:00    10768 Query    SELECT CRC32('test-string')
    2020-03-06T14:43:37.177919+08:00    10768 Query    SELECT CRC32('a')
    2020-03-06T14:43:37.178028+08:00    10768 Query    SELECT CRC32('a')
    2020-03-06T14:43:37.178160+08:00    10768 Query    SHOW VARIABLES LIKE 'wsrep_on'
    2020-03-06T14:43:37.179343+08:00    10768 Query    SHOW DATABASES

    2020-03-06T14:43:37.179668+08:00    10768 Query    SHOW /*!50002 FULL*/ TABLES FROM `kk`

    2020-03-06T14:43:37.179881+08:00    10768 Query    /*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */

    2020-03-06T14:43:37.179971+08:00    10768 Query    USE `kk`
    
    2020-03-06T14:43:37.180070+08:00    10768 Query    SHOW CREATE TABLE `kk`.`tb1`

    2020-03-06T14:43:37.180207+08:00    10768 Query    /*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */
    2020-03-06T14:43:37.180654+08:00    10768 Query    EXPLAIN SELECT * FROM `kk`.`tb1` WHERE 1=1
    2020-03-06T14:43:37.181255+08:00    10768 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) ORDER BY `id` LIMIT 1 /*first lower boundary*/
    2020-03-06T14:43:37.187127+08:00    10768 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE `id` IS NOT NULL ORDER BY `id` LIMIT 1 /*key_len*/
    2020-03-06T14:43:37.187432+08:00    10768 Query    EXPLAIN SELECT /*!40001 SQL_NO_CACHE */ * FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE `id` >= '1' /*key_len*/

    2020-03-06T14:43:37.187744+08:00    10768 Query    USE `kk`

    2020-03-06T14:43:37.187845+08:00    10768 Query    DELETE FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1'

    2020-03-06T14:43:37.199498+08:00    10768 Query    USE `kk`

    2020-03-06T14:43:37.199871+08:00    10768 Query    EXPLAIN SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) ORDER BY `id` LIMIT 999, 2 /*next chunk boundary*/
    2020-03-06T14:43:37.200305+08:00    10768 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) ORDER BY `id` LIMIT 999, 2 /*next chunk boundary*/
    2020-03-06T14:43:37.200941+08:00    10768 Query    EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) AND ((`id` <= '1000')) /*explain checksum chunk*/
    2020-03-06T14:43:37.201666+08:00    10768 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '1', 'PRIMARY', '1', '1000', COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) AND ((`id` <= '1000')) /*checksum chunk*/
    2020-03-06T14:43:37.214333+08:00    10768 Query    SHOW WARNINGS
    2020-03-06T14:43:37.214727+08:00    10768 Query    SELECT this_crc, this_cnt FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '1'
    2020-03-06T14:43:37.215026+08:00    10768 Query    UPDATE `kk`.`ck` SET chunk_time = '0.012682', master_crc = '926eeb0d', master_cnt = '1000' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '1'
    ↑--master将前面计算出来的hash，赋值给master_cnt和master_crc
    
    2020-03-06T14:43:37.230006+08:00    10768 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
    2020-03-06T14:43:37.231172+08:00    10768 Query    EXPLAIN SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) ORDER BY `id` LIMIT 39425, 2 /*next chunk boundary*/
    ↑--第二chunk查询计算
    
    2020-03-06T14:43:37.231655+08:00    10768 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) ORDER BY `id` LIMIT 39425, 2 /*next chunk boundary*/
    2020-03-06T14:43:37.233610+08:00    10768 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) ORDER BY `id` DESC LIMIT 1 /*last upper boundary*/
    ↑--找主键最大值
    
    2020-03-06T14:43:37.233937+08:00    10768 Query    EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) AND ((`id` <= '10689')) /*explain checksum chunk*/
    ↑--一共就10689，就都包含给chunk 2来计算了。
    
    2020-03-06T14:43:37.234297+08:00    10768 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '2', 'PRIMARY', '1001', '10689', COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) AND ((`id` <= '10689')) /*checksum chunk*/
    ↑--计算主体。 replace动作写binlog且同步给slave，slave也会计算自己的结果插入到表。
    
    2020-03-06T14:43:37.254131+08:00    10768 Query    SHOW WARNINGS
    2020-03-06T14:43:37.254494+08:00    10768 Query    SELECT this_crc, this_cnt FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '2'
    2020-03-06T14:43:37.254773+08:00    10768 Query    UPDATE `kk`.`ck` SET chunk_time = '0.019770', master_crc = 'e824e816', master_cnt = '9689' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '2'
    ↑--master将前面计算出来的hash，赋值给master_cnt和master_crc，update动作写binlog且同步给slave，将master的值通过前面查出的结果获得，并通过update动作写到表的master字段里，此时slave也会写同样的值，因为SQL写的是value，不是replace的表达式。

    2020-03-06T14:43:37.269042+08:00    10768 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
    2020-03-06T14:43:37.270207+08:00    10768 Query    EXPLAIN SELECT COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` < '1')) ORDER BY `id` /*explain past lower chunk*/
    ↑--找比最小值1还小的，计算hash？ 这是什么操作？

    2020-03-06T14:43:37.270735+08:00    10768 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '3', 'PRIMARY', NULL, '1', COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` < '1')) ORDER BY `id` /*past lower chunk*/
    2020-03-06T14:43:37.281908+08:00    10768 Query    SHOW WARNINGS
    2020-03-06T14:43:37.282276+08:00    10768 Query    SELECT this_crc, this_cnt FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '3'
    2020-03-06T14:43:37.282624+08:00    10768 Query    UPDATE `kk`.`ck` SET chunk_time = '0.011094', master_crc = '0', master_cnt = '0' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '3'
    2020-03-06T14:43:37.297260+08:00    10768 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
    2020-03-06T14:43:37.298294+08:00    10768 Query    EXPLAIN SELECT COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` > '10689')) ORDER BY `id` /*explain past upper chunk*/
    ↑--找比最大值10689还大的，计算hash？ 这是什么操作？

    2020-03-06T14:43:37.298685+08:00    10768 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '4', 'PRIMARY', '10689', NULL, COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` > '10689')) ORDER BY `id` /*past upper chunk*/
    2020-03-06T14:43:37.309800+08:00    10768 Query    SHOW WARNINGS
    2020-03-06T14:43:37.310156+08:00    10768 Query    SELECT this_crc, this_cnt FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '4'
    2020-03-06T14:43:37.310479+08:00    10768 Query    UPDATE `kk`.`ck` SET chunk_time = '0.011045', master_crc = '0', master_cnt = '0' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '4'
    ↑--这就完成了master的统计。此时slave上都复制到了前面replace into 及 update的动作，得到了master的计算结果。

    2020-03-06T14:43:37.323879+08:00    10768 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
    2020-03-06T14:43:37.324911+08:00    10768 Query    SHOW VARIABLES LIKE 'wsrep_on'
    2020-03-06T14:43:37.325925+08:00    10768 Query    SHOW MASTER STATUS
    2020-03-06T14:43:37.634065+08:00    10768 Quit    
    2020-03-06T14:43:44.846039+08:00     186 Query    set global general_log=0
    [root@mysqlvm1 logs]#
    ```

- slave：
    > **42是pt-table-checksum的会话ID，5是rep的会话ID。**
    ```
    Time         Id Command  Argument
    2020-03-06T22:49:47.203084+08:00      42 Connect    chk@192.168.188.101 on using TCP/IP
    2020-03-06T22:49:47.203636+08:00      42 Query    SHOW VARIABLES LIKE 'innodb\_lock_wait_timeout'
    2020-03-06T22:49:47.205373+08:00      42 Query    SET SESSION innodb_lock_wait_timeout=1
    2020-03-06T22:49:47.205859+08:00      42 Query    SHOW VARIABLES LIKE 'wait\_timeout'
    2020-03-06T22:49:47.207269+08:00      42 Query    SET SESSION wait_timeout=10000
    2020-03-06T22:49:47.207763+08:00      42 Query    SELECT @@SQL_MODE
    2020-03-06T22:49:47.208133+08:00      42 Query    SET @@SQL_QUOTE_SHOW_CREATE = 1/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'*/
    2020-03-06T22:49:47.208482+08:00      42 Query    SELECT @@SERVER_ID
    2020-03-06T22:49:47.209269+08:00      42 Query    SELECT @@server_id /*!50038 , @@hostname*/
    2020-03-06T22:49:47.209638+08:00      42 Query    SHOW VARIABLES LIKE 'wsrep_on'
    2020-03-06T22:49:47.210938+08:00      42 Query    SHOW GRANTS FOR CURRENT_USER()
    2020-03-06T22:49:47.211279+08:00      42 Query    SHOW FULL PROCESSLIST
    2020-03-06T22:49:47.223494+08:00      42 Query    SHOW VARIABLES LIKE 'wsrep_on'
    2020-03-06T22:49:47.224862+08:00      42 Query    SELECT @@SERVER_ID
    2020-03-06T22:49:47.228344+08:00      42 Query    SHOW VARIABLES LIKE 'wsrep_on'
    2020-03-06T22:49:47.230159+08:00      42 Query    SELECT @@SERVER_ID
    2020-03-06T22:49:47.233638+08:00      42 Query    SHOW MASTER STATUS
    2020-03-06T22:49:47.234095+08:00      42 Query    SHOW SLAVE STATUS
    2020-03-06T22:49:47.234814+08:00      42 Query    SHOW VARIABLES LIKE 'slave_skip_errors'
    2020-03-06T22:49:47.261476+08:00      5 Query    CREATE DATABASE IF NOT EXISTS `kk` /* pt-table-checksum */
    2020-03-06T22:49:47.263889+08:00      42 Query    SHOW TABLES FROM `kk` LIKE 'ck'
    2020-03-06T22:49:47.266187+08:00      42 Query    SELECT CONCAT(@@hostname, @@port)
    2020-03-06T22:49:47.271187+08:00      42 Query    SHOW TABLES FROM `kk` LIKE 'tb1'
    2020-03-06T22:49:47.271840+08:00      42 Query    /*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */
    2020-03-06T22:49:47.271933+08:00       5 Query    CREATE TABLE IF NOT EXISTS `kk`.`ck` (
    db       CHAR(64)   NOT NULL,
    tbl      CHAR(64)   NOT NULL,
    chunk     INT     NOT NULL,
    chunk_time   FLOAT      NULL,
    chunk_index  VARCHAR(200)   NULL,
    lower_boundary TEXT       NULL,
    upper_boundary TEXT       NULL,
    this_crc    CHAR(40)   NOT NULL,
    this_cnt    INT     NOT NULL,
    master_crc   CHAR(40)     NULL,
    master_cnt   INT       NULL,
    ts       TIMESTAMP  NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (db, tbl, chunk),
    INDEX ts_db_tbl (ts, db, tbl)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8

    2020-03-06T22:49:47.272291+08:00      42 Query    USE `kk`

    2020-03-06T22:49:47.272658+08:00      42 Query    SHOW CREATE TABLE `kk`.`tb1`

    2020-03-06T22:49:47.273045+08:00      42 Query    /*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */
    2020-03-06T22:49:47.285984+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.286259+08:00      5 Query    DELETE FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1'
    2020-03-06T22:49:47.286280+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.299783+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.300636+08:00      5 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '1', 'PRIMARY', '1', '1000', COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) AND ((`id` <= '1000')) /*checksum chunk*/
    2020-03-06T22:49:47.300676+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.311783+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.312225+08:00      5 Query    UPDATE `kk`.`ck` SET chunk_time = '0.011435', master_crc = '926eeb0d', master_cnt = '1000' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '1'
    2020-03-06T22:49:47.312227+08:00      42 Query    SHOW SLAVE STATUS
    2020-03-06T22:49:47.312268+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.335682+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.342777+08:00      5 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '2', 'PRIMARY', '1001', '10689', COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) AND ((`id` <= '10689')) /*checksum chunk*/
    2020-03-06T22:49:47.342888+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.348903+08:00      42 Query    SHOW SLAVE STATUS
    2020-03-06T22:49:47.354269+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.354504+08:00      5 Query    UPDATE `kk`.`ck` SET chunk_time = '0.018387', master_crc = 'e824e816', master_cnt = '9689' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '2'
    2020-03-06T22:49:47.354518+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.364174+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.364436+08:00      5 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '3', 'PRIMARY', NULL, '1', COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` < '1')) ORDER BY `id` /*past lower chunk*/
    2020-03-06T22:49:47.364450+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.374809+08:00      42 Query    SHOW SLAVE STATUS
    2020-03-06T22:49:47.375249+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.375484+08:00      5 Query    UPDATE `kk`.`ck` SET chunk_time = '0.010829', master_crc = '0', master_cnt = '0' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '3'
    2020-03-06T22:49:47.375499+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.389091+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.389449+08:00      5 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '4', 'PRIMARY', '10689', NULL, COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` > '10689')) ORDER BY `id` /*past upper chunk*/
    2020-03-06T22:49:47.389487+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.400687+08:00      5 Query    BEGIN
    2020-03-06T22:49:47.400995+08:00      5 Query    UPDATE `kk`.`ck` SET chunk_time = '0.010580', master_crc = '0', master_cnt = '0' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '4'
    2020-03-06T22:49:47.401025+08:00      5 Query    COMMIT /* implicit, from Xid_log_event */
    2020-03-06T22:49:47.401221+08:00      42 Query    SHOW SLAVE STATUS
    ↑--从这开始才是slave独立的部分，前面通过表达式以replace的方式记录了slave节点的计算结果，下面开始做比对。

    2020-03-06T22:49:47.405727+08:00      42 Query    SHOW SLAVE STATUS
    2020-03-06T22:49:47.406513+08:00      42 Query    SHOW VARIABLES LIKE 'version%'
    2020-03-06T22:49:47.408394+08:00      42 Query    SHOW ENGINES
    2020-03-06T22:49:47.409063+08:00      42 Query    SHOW VARIABLES LIKE 'innodb_version'
    2020-03-06T22:49:47.410603+08:00      42 Query    SELECT MASTER_POS_WAIT('mysql-bin.000001', 3943054, 60 )
    2020-03-06T22:49:47.707337+08:00      42 Query    SELECT MAX(chunk) FROM `kk`.`ck` WHERE db='kk' AND tbl='tb1' AND master_crc IS NOT NULL
    2020-03-06T22:49:47.708707+08:00      42 Query    SELECT CONCAT(db, '.', tbl) AS `table`, chunk, chunk_index, lower_boundary, upper_boundary, COALESCE(this_cnt-master_cnt, 0) AS cnt_diff, COALESCE(this_crc <> master_crc OR ISNULL(master_crc) <> ISNULL(this_crc), 0) AS crc_diff, this_cnt, master_cnt, this_crc, master_crc FROM `kk`.`ck` WHERE (master_cnt <> this_cnt OR master_crc <> this_crc OR ISNULL(master_crc) <> ISNULL(this_crc)) AND (db='kk' AND tbl='tb1')   
    ↑--这就返回了对比结果。

    2020-03-06T22:49:47.710454+08:00      42 Quit    
    2020-03-06T22:49:55.921929+08:00      2 Query    set global general_log=0
    [root@mysqlvm1-2 logs]# 

    ```



# 主从数据一致性修复
修复前提：通过checksum完成计算对比。
不checksum直接执行修复的话，没动作的。



## 使用pt-table-sync输出修复语句

```
[root@mysqlvm1 logs]# pt-table-sync h-192.168.188.101,P=3306,u=chk,p=chk --replicate kk.ck --recursion-method="processlist" --print
```



## 使用pt-table-sync直接执行修复(无需输出修复语句）

```
[root@mysqlvm1 logs]# pt-table-sync h=192.168.188.101,P=3306,u=chk,p=chk --replicate kk.ck --recursion-method="processlist" --execute
```



## 探索pt-table-sync的原理：

<font color=red>binlog改为statement，关闭了自动提交，然后在master上将对比出差异的数据行进行select，再用结果replace一遍。</font>

通过这一些列的动作产生的binlog同步给slave后，不一致的问题便解决了。


```
[root@mysqlvm1 logs]# head -200 general.log
mysqld, Version: 5.7.26-log (MySQL Community Server (GPL)). started with:
Tcp port: 3306 Unix socket: /data/mysql/mysql3306/tmp/mysql.sock
Time         Id Command  Argument
2020-03-06T16:47:18.727030+08:00    10809 Connect    chk@192.168.188.101 on using TCP/IP
2020-03-06T16:47:18.727323+08:00    10809 Query    SHOW VARIABLES LIKE 'innodb\_lock_wait_timeout'
2020-03-06T16:47:18.729426+08:00    10809 Query    SET SESSION innodb_lock_wait_timeout=1
2020-03-06T16:47:18.729824+08:00    10809 Query    SHOW VARIABLES LIKE 'wait\_timeout'
2020-03-06T16:47:18.732417+08:00    10809 Query    SET SESSION wait_timeout=10000
2020-03-06T16:47:18.732608+08:00    10809 Query    SELECT @@SQL_MODE
2020-03-06T16:47:18.732771+08:00    10809 Query    SET @@SQL_QUOTE_SHOW_CREATE = 1/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'*/
2020-03-06T16:47:18.732926+08:00    10809 Query    SELECT @@server_id /*!50038 , @@hostname*/
2020-03-06T16:47:18.733060+08:00    10809 Query    SELECT @@SQL_MODE
2020-03-06T16:47:18.733160+08:00    10809 Query    SET SQL_MODE=',NO_AUTO_VALUE_ON_ZERO,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'
2020-03-06T16:47:18.733323+08:00    10809 Query    SHOW VARIABLES LIKE 'version%'
2020-03-06T16:47:18.734542+08:00    10809 Query    SHOW ENGINES
2020-03-06T16:47:18.734873+08:00    10809 Query    SHOW VARIABLES LIKE 'innodb_version'
2020-03-06T16:47:18.735959+08:00    10809 Query    SELECT @@binlog_format
2020-03-06T16:47:18.736069+08:00    10809 Query    /*!50108 SET @@binlog_format := 'STATEMENT'*/
2020-03-06T16:47:18.736146+08:00    10809 Query    SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
2020-03-06T16:47:18.736326+08:00    10809 Query    SHOW /*!40103 GLOBAL*/ VARIABLES
2020-03-06T16:47:18.738122+08:00    10809 Query    SELECT VERSION()
2020-03-06T16:47:18.738403+08:00    10809 Query    SHOW ENGINES
2020-03-06T16:47:18.738941+08:00    10809 Query    SHOW VARIABLES LIKE 'wsrep_on'
2020-03-06T16:47:18.740934+08:00    10809 Query    SELECT @@SERVER_ID
2020-03-06T16:47:18.741129+08:00    10809 Query    SHOW GRANTS FOR CURRENT_USER()
2020-03-06T16:47:18.741265+08:00    10809 Query    SHOW FULL PROCESSLIST
2020-03-06T16:47:18.763144+08:00    10809 Query    SHOW VARIABLES LIKE 'wsrep_on'
2020-03-06T16:47:18.764397+08:00    10809 Query    SELECT @@SERVER_ID
2020-03-06T16:47:18.768420+08:00    10809 Query    SHOW VARIABLES LIKE 'wsrep_on'
2020-03-06T16:47:18.769773+08:00    10809 Query    SELECT @@SERVER_ID
2020-03-06T16:47:18.783633+08:00    10809 Query    SHOW DATABASES LIKE 'kk'
2020-03-06T16:47:18.783931+08:00    10809 Query    CREATE DATABASE IF NOT EXISTS `kk` /* pt-table-checksum */

2020-03-06T16:47:18.794248+08:00    10809 Query    USE `kk`

2020-03-06T16:47:18.794682+08:00    10809 Query    SHOW TABLES FROM `kk` LIKE 'ck'
2020-03-06T16:47:18.796726+08:00    10809 Query    CREATE TABLE IF NOT EXISTS `kk`.`ck` (
   db       CHAR(64)   NOT NULL,
   tbl      CHAR(64)   NOT NULL,
   chunk     INT     NOT NULL,
   chunk_time   FLOAT      NULL,
   chunk_index  VARCHAR(200)   NULL,
   lower_boundary TEXT       NULL,
   upper_boundary TEXT       NULL,
   this_crc    CHAR(40)   NOT NULL,
   this_cnt    INT     NOT NULL,
   master_crc   CHAR(40)     NULL,
   master_cnt   INT       NULL,
   ts       TIMESTAMP  NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
   PRIMARY KEY (db, tbl, chunk),
   INDEX ts_db_tbl (ts, db, tbl)
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8
2020-03-06T16:47:18.811208+08:00    10809 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
2020-03-06T16:47:18.812781+08:00    10809 Query    SELECT CONCAT(@@hostname, @@port)
2020-03-06T16:47:18.814847+08:00    10809 Query    SELECT CRC32('test-string')
2020-03-06T16:47:18.815067+08:00    10809 Query    SELECT CRC32('a')
2020-03-06T16:47:18.815194+08:00    10809 Query    SELECT CRC32('a')
2020-03-06T16:47:18.815346+08:00    10809 Query    SHOW VARIABLES LIKE 'wsrep_on'
2020-03-06T16:47:18.817074+08:00    10809 Query    SHOW DATABASES

2020-03-06T16:47:18.817444+08:00    10809 Query    SHOW /*!50002 FULL*/ TABLES FROM `kk`

2020-03-06T16:47:18.817738+08:00    10809 Query    /*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */

2020-03-06T16:47:18.817862+08:00    10809 Query    USE `kk`

2020-03-06T16:47:18.817998+08:00    10809 Query    SHOW CREATE TABLE `kk`.`tb1`

2020-03-06T16:47:18.818265+08:00    10809 Query    /*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */
2020-03-06T16:47:18.818797+08:00    10809 Query    EXPLAIN SELECT * FROM `kk`.`tb1` WHERE 1=1
2020-03-06T16:47:18.819619+08:00    10809 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) ORDER BY `id` LIMIT 1 /*first lower boundary*/
2020-03-06T16:47:18.829546+08:00    10809 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE `id` IS NOT NULL ORDER BY `id` LIMIT 1 /*key_len*/
2020-03-06T16:47:18.829972+08:00    10809 Query    EXPLAIN SELECT /*!40001 SQL_NO_CACHE */ * FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE `id` >= '1' /*key_len*/

2020-03-06T16:47:18.830439+08:00    10809 Query    USE `kk`

2020-03-06T16:47:18.830634+08:00    10809 Query    DELETE FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1'

2020-03-06T16:47:18.839462+08:00    10809 Query    USE `kk`

2020-03-06T16:47:18.839762+08:00    10809 Query    EXPLAIN SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) ORDER BY `id` LIMIT 999, 2 /*next chunk boundary*/
2020-03-06T16:47:18.840288+08:00    10809 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) ORDER BY `id` LIMIT 999, 2 /*next chunk boundary*/
2020-03-06T16:47:18.841131+08:00    10809 Query    EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) AND ((`id` <= '1000')) /*explain checksum chunk*/
2020-03-06T16:47:18.842117+08:00    10809 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '1', 'PRIMARY', '1', '1000', COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1')) AND ((`id` <= '1000')) /*checksum chunk*/
2020-03-06T16:47:18.855784+08:00    10809 Query    SHOW WARNINGS
2020-03-06T16:47:18.856478+08:00    10809 Query    SELECT this_crc, this_cnt FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '1'
2020-03-06T16:47:18.856865+08:00    10809 Query    UPDATE `kk`.`ck` SET chunk_time = '0.013475', master_crc = '926eeb0d', master_cnt = '1000' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '1'
2020-03-06T16:47:18.871439+08:00    10809 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
2020-03-06T16:47:18.872314+08:00    10809 Query    EXPLAIN SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) ORDER BY `id` LIMIT 37104, 2 /*next chunk boundary*/
2020-03-06T16:47:18.872654+08:00    10809 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) ORDER BY `id` LIMIT 37104, 2 /*next chunk boundary*/
2020-03-06T16:47:18.874787+08:00    10809 Query    SELECT /*!40001 SQL_NO_CACHE */ `id` FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) ORDER BY `id` DESC LIMIT 1 /*last upper boundary*/
2020-03-06T16:47:18.875122+08:00    10809 Query    EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) AND ((`id` <= '10689')) /*explain checksum chunk*/
2020-03-06T16:47:18.875563+08:00    10809 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '2', 'PRIMARY', '1001', '10689', COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`dtl` using utf8mb4), CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` >= '1001')) AND ((`id` <= '10689')) /*checksum chunk*/
2020-03-06T16:47:18.892989+08:00    10809 Query    SHOW WARNINGS
2020-03-06T16:47:18.893382+08:00    10809 Query    SELECT this_crc, this_cnt FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '2'
2020-03-06T16:47:18.893748+08:00    10809 Query    UPDATE `kk`.`ck` SET chunk_time = '0.017354', master_crc = 'e824e816', master_cnt = '9689' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '2'
2020-03-06T16:47:18.907379+08:00    10809 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
2020-03-06T16:47:18.908628+08:00    10809 Query    EXPLAIN SELECT COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` < '1')) ORDER BY `id` /*explain past lower chunk*/
2020-03-06T16:47:18.909171+08:00    10809 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '3', 'PRIMARY', NULL, '1', COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` < '1')) ORDER BY `id` /*past lower chunk*/
2020-03-06T16:47:18.921063+08:00    10809 Query    SHOW WARNINGS
2020-03-06T16:47:18.921467+08:00    10809 Query    SELECT this_crc, this_cnt FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '3'
2020-03-06T16:47:18.921755+08:00    10809 Query    UPDATE `kk`.`ck` SET chunk_time = '0.011793', master_crc = '0', master_cnt = '0' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '3'
2020-03-06T16:47:18.936930+08:00    10809 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
2020-03-06T16:47:18.937811+08:00    10809 Query    EXPLAIN SELECT COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` > '10689')) ORDER BY `id` /*explain past upper chunk*/
2020-03-06T16:47:18.938234+08:00    10809 Query    REPLACE INTO `kk`.`ck` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT 'kk', 'tb1', '4', 'PRIMARY', '10689', NULL, COUNT(*), '0' FROM `kk`.`tb1` FORCE INDEX(`PRIMARY`) WHERE ((`id` > '10689')) ORDER BY `id` /*past upper chunk*/
2020-03-06T16:47:18.948707+08:00    10809 Query    SHOW WARNINGS
2020-03-06T16:47:18.949051+08:00    10809 Query    SELECT this_crc, this_cnt FROM `kk`.`ck` WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '4'
2020-03-06T16:47:18.949334+08:00    10809 Query    UPDATE `kk`.`ck` SET chunk_time = '0.010380', master_crc = '0', master_cnt = '0' WHERE db = 'kk' AND tbl = 'tb1' AND chunk = '4'
2020-03-06T16:47:18.962496+08:00    10809 Query    SHOW GLOBAL STATUS LIKE 'Threads_running'
2020-03-06T16:47:18.963413+08:00    10809 Query    SHOW VARIABLES LIKE 'wsrep_on'
2020-03-06T16:47:18.964415+08:00    10809 Query    SHOW MASTER STATUS
2020-03-06T16:47:19.271998+08:00    10809 Quit
 
-------------------------------------分割线-------------------------------------
上面是checksum，下面是sync_execute
-------------------------------------分割线-------------------------------------
 
2020-03-06T16:47:23.308739+08:00    10810 Connect    chk@192.168.188.101 on using TCP/IP
2020-03-06T16:47:23.308962+08:00    10810 Query    set autocommit=0
2020-03-06T16:47:23.309239+08:00    10810 Query    SHOW VARIABLES LIKE 'wait\_timeout'
2020-03-06T16:47:23.310674+08:00    10810 Query    SET SESSION wait_timeout=10000
2020-03-06T16:47:23.310800+08:00    10810 Query    SELECT @@SQL_MODE
2020-03-06T16:47:23.310903+08:00    10810 Query    SET @@SQL_QUOTE_SHOW_CREATE = 1/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'*/
2020-03-06T16:47:23.311045+08:00    10810 Query    /*!40101 SET @@SQL_MODE := CONCAT(@@SQL_MODE, ',NO_AUTO_VALUE_ON_ZERO')*/
2020-03-06T16:47:23.311218+08:00    10810 Query    SHOW VARIABLES LIKE 'version%'
2020-03-06T16:47:23.312218+08:00    10810 Query    SHOW ENGINES
2020-03-06T16:47:23.312508+08:00    10810 Query    SHOW VARIABLES LIKE 'innodb_version'
2020-03-06T16:47:23.313577+08:00    10810 Query    SELECT @@binlog_format
2020-03-06T16:47:23.313681+08:00    10810 Query    /*!50108 SET @@binlog_format := 'STATEMENT'*/
2020-03-06T16:47:23.313756+08:00    10810 Query    SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
2020-03-06T16:47:23.313889+08:00    10810 Query    SELECT CONCAT(@@hostname, @@port)
2020-03-06T16:47:23.314609+08:00    10810 Quit    
2020-03-06T16:47:23.314709+08:00    10811 Connect    chk@192.168.188.101 on using TCP/IP
2020-03-06T16:47:23.314836+08:00    10811 Query    set autocommit=0
2020-03-06T16:47:23.315014+08:00    10811 Query    SHOW VARIABLES LIKE 'wait\_timeout'
2020-03-06T16:47:23.315996+08:00    10811 Query    SET SESSION wait_timeout=10000
2020-03-06T16:47:23.316200+08:00    10811 Query    SELECT @@SQL_MODE
2020-03-06T16:47:23.316362+08:00    10811 Query    SET @@SQL_QUOTE_SHOW_CREATE = 1/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'*/
2020-03-06T16:47:23.316450+08:00    10811 Query    /*!40101 SET @@SQL_MODE := CONCAT(@@SQL_MODE, ',NO_AUTO_VALUE_ON_ZERO')*/
2020-03-06T16:47:23.316572+08:00    10811 Query    SHOW VARIABLES LIKE 'version%'
2020-03-06T16:47:23.317523+08:00    10811 Query    SHOW ENGINES
2020-03-06T16:47:23.317764+08:00    10811 Query    SHOW VARIABLES LIKE 'innodb_version'
2020-03-06T16:47:23.318765+08:00    10811 Query    SELECT @@binlog_format
2020-03-06T16:47:23.318860+08:00    10811 Query    /*!50108 SET @@binlog_format := 'STATEMENT'*/
2020-03-06T16:47:23.318927+08:00    10811 Query    SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
2020-03-06T16:47:23.319745+08:00    10812 Connect    chk@192.168.188.101 on using TCP/IP
2020-03-06T16:47:23.319838+08:00    10812 Query    set autocommit=0
2020-03-06T16:47:23.319977+08:00    10812 Query    SHOW VARIABLES LIKE 'wait\_timeout'
2020-03-06T16:47:23.320966+08:00    10812 Query    SET SESSION wait_timeout=10000
2020-03-06T16:47:23.321164+08:00    10812 Query    SELECT @@SQL_MODE
2020-03-06T16:47:23.321292+08:00    10812 Query    SET @@SQL_QUOTE_SHOW_CREATE = 1/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'*/
2020-03-06T16:47:23.321459+08:00    10812 Query    /*!40101 SET @@SQL_MODE := CONCAT(@@SQL_MODE, ',NO_AUTO_VALUE_ON_ZERO')*/
2020-03-06T16:47:23.321580+08:00    10812 Query    SHOW VARIABLES LIKE 'version%'
2020-03-06T16:47:23.322690+08:00    10812 Query    SHOW ENGINES
2020-03-06T16:47:23.323204+08:00    10812 Query    SHOW VARIABLES LIKE 'innodb_version'
2020-03-06T16:47:23.324631+08:00    10812 Query    SELECT @@binlog_format
2020-03-06T16:47:23.324968+08:00    10812 Query    /*!50108 SET @@binlog_format := 'STATEMENT'*/
2020-03-06T16:47:23.325256+08:00    10812 Query    SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
2020-03-06T16:47:23.325688+08:00    10811 Query    SELECT @@SERVER_ID
2020-03-06T16:47:23.326099+08:00    10811 Query    SELECT db, tbl, CONCAT(db, '.', tbl) AS `table`, chunk, chunk_index, lower_boundary, upper_boundary, COALESCE(this_cnt-master_cnt, 0) AS cnt_diff, COALESCE(this_crc <> master_crc OR ISNULL(master_crc) <> ISNULL(this_crc), 0) AS crc_diff, this_cnt, master_cnt, this_crc, master_crc FROM kk.ck WHERE master_cnt <> this_cnt OR master_crc <> this_crc OR ISNULL(master_crc) <> ISNULL(this_crc)
2020-03-06T16:47:23.326651+08:00    10811 Query    SHOW GRANTS FOR CURRENT_USER()
2020-03-06T16:47:23.326814+08:00    10811 Query    SHOW FULL PROCESSLIST
2020-03-06T16:47:23.343296+08:00    10811 Query    /*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */

2020-03-06T16:47:23.343449+08:00    10811 Query    USE `kk`
2020-03-06T16:47:23.343568+08:00    10811 Query    SHOW CREATE TABLE `kk`.`tb1`

2020-03-06T16:47:23.343708+08:00    10811 Query    /*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */
2020-03-06T16:47:23.349829+08:00    10811 Query    SELECT table_schema, table_name FROM information_schema.key_column_usage WHERE constraint_schema='kk' AND referenced_table_name='tb1'
2020-03-06T16:47:23.353601+08:00    10811 Query    SET NAMES 'utf8mb4'
2020-03-06T16:47:23.353746+08:00    10812 Query    SET NAMES 'utf8mb4'
2020-03-06T16:47:23.355175+08:00    10811 Query    SELECT MIN(`id`), MAX(`id`) FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE (((`id` >= '1')) AND ((`id` <= '1000')))
2020-03-06T16:47:23.355543+08:00    10811 Query    EXPLAIN SELECT * FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE ((`id` >= '1')) AND ((`id` <= '1000'))
2020-03-06T16:47:23.356178+08:00    10811 Query    SELECT CRC32('test-string')
2020-03-06T16:47:23.356967+08:00    10811 Query    SELECT CRC32('a')
2020-03-06T16:47:23.357159+08:00    10811 Query    SELECT CRC32('a')

2020-03-06T16:47:23.357393+08:00    10811 Query    USE `kk`

2020-03-06T16:47:23.359698+08:00    10811 Query    SET @crc := '', @cnt := 0
2020-03-06T16:47:23.360271+08:00    10811 Query    commit
2020-03-06T16:47:23.360616+08:00    10811 Query    START TRANSACTION /*!40108 WITH CONSISTENT SNAPSHOT */
2020-03-06T16:47:23.360754+08:00    10811 Query    SELECT /*kk.tb1:1/2*/ 0 AS chunk_num, COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, `dtl`, CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE (`id` = 0) AND ((((`id` >= '1')) AND ((`id` <= '1000')))) FOR UPDATE
2020-03-06T16:47:23.361100+08:00    10812 Query    SHOW MASTER STATUS
2020-03-06T16:47:23.365993+08:00    10811 Query    SET @crc := '', @cnt := 0
2020-03-06T16:47:23.366433+08:00    10811 Query    commit
2020-03-06T16:47:23.366695+08:00    10811 Query    START TRANSACTION /*!40108 WITH CONSISTENT SNAPSHOT */
2020-03-06T16:47:23.366856+08:00    10811 Query    SELECT /*kk.tb1:2/2*/ 1 AS chunk_num, COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, `dtl`, CONCAT(ISNULL(`dtl`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE (`id` >= '1') AND ((((`id` >= '1')) AND ((`id` <= '1000')))) FOR UPDATE
2020-03-06T16:47:23.367682+08:00    10812 Query    SHOW MASTER STATUS
2020-03-06T16:47:23.373480+08:00    10811 Query    SET @crc := '', @cnt := 0
2020-03-06T16:47:23.374062+08:00    10811 Query    SELECT /*rows in chunk*/ `id`, `dtl`, CRC32(CONCAT_WS('#', `id`, `dtl`, CONCAT(ISNULL(`dtl`)))) AS __crc FROM `kk`.`tb1` FORCE INDEX (`PRIMARY`) WHERE (`id` >= '1') AND (((`id` >= '1')) AND ((`id` <= '1000'))) ORDER BY `id` FOR UPDATE

--------------------------------分割线-----------------------------
sync通过上面这串动作找出了差异的数据行，接下来通过在master上 select、replace一下select的值，这一系列动作下来之后，通过主从复制，就把slave的非一致性的表给修复过来了。由于关闭了自动提交，所以批量提交的好处就是，产生了并不是很多的事务数量
--------------------------------分割线-----------------------------

2020-03-06T16:47:23.384301+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='11' LIMIT 1
2020-03-06T16:47:23.384671+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('11', '5c4002da3c7225c28770') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/
2020-03-06T16:47:23.384958+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='12' LIMIT 1
2020-03-06T16:47:23.385203+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('12', '2315766ce16a68625540') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/
2020-03-06T16:47:23.385533+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='13' LIMIT 1
2020-03-06T16:47:23.385920+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('13', '62641663c970785f3b68') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/
2020-03-06T16:47:23.386332+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='14' LIMIT 1
2020-03-06T16:47:23.386618+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('14', '041cf3f3d89a93546622') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/
2020-03-06T16:47:23.386857+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='15' LIMIT 1
2020-03-06T16:47:23.387039+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('15', '142d9dc9bbe6925da3a3') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/
2020-03-06T16:47:23.387226+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='16' LIMIT 1
2020-03-06T16:47:23.387380+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('16', 'f0b31d2d2bb458f2a501') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/
2020-03-06T16:47:23.387534+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='17' LIMIT 1
2020-03-06T16:47:23.387689+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('17', 'cb257a5cde0758ff4efe') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/
2020-03-06T16:47:23.387892+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='18' LIMIT 1
2020-03-06T16:47:23.388051+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('18', 'b3a8a0c6908c2dc43b67') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/

-------省略大量-----------------------

2020-03-06T16:47:29.504789+08:00    10811 Query    SELECT `id`, `dtl` FROM `kk`.`tb1` WHERE `id`='10689' LIMIT 1
2020-03-06T16:47:29.504934+08:00    10811 Query    REPLACE INTO `kk`.`tb1`(`id`, `dtl`) VALUES ('10689', '4857ff3617f9fc4a736a') /*percona-toolkit src_db:kk src_tbl:tb1 src_dsn:P=3306,h=192.168.188.101,p=...,u=chk dst_db:kk dst_tbl:tb1 dst_dsn:P=3306,h=192.168.188.211,p=...,u=chk lock:1 transaction:1 changing_src:kk.ck replicate:kk.ck bidirectional:0 pid:37837 user:root host:mysqlvm1*/
2020-03-06T16:47:29.505100+08:00    10811 Query    commit
2020-03-06T16:47:29.534135+08:00    10811 Query    commit
2020-03-06T16:47:29.534381+08:00    10811 Quit    
2020-03-06T16:47:29.534468+08:00    10812 Query    commit
2020-03-06T16:47:29.535170+08:00    10812 Quit    
2020-03-06T16:47:34.209553+08:00     186 Query    set global general_log=0
[root@mysqlvm1 logs]# 
```



# 主从不一致的几种场景总结分析、解决和预防

## 从库宕机，从库启动后重复写入数据报错

- 解决与预防

  ```
  relay_log_info_repository=TABLE    #InnoDB
  ```

  > 参数解释说明:
  >
  > 若relay_log_info_repository为FILE，当设置为0，交由OS刷新磁盘，受参数sync_relay_log_info的影响，默认为10000次刷新到磁盘；
  >
  > 若relay_log_info_repository为TABLE，且为INNODB存储，则无论为任何值，则都每次event都会更新表。
  >
  > relay_log_info_repository=table可以避免relay.info更新不及时，SLAVE 重启后导致的主从复制数据重复插入报错问题。

- 修改步骤：

  ```
  stop slave;
  set global relay_log_info_repository='TABLE';
  
  或在my.cnf中设置:
  relay_log_info_repository = TABLE
  ```



## 主库宕机

- 解决与预防:
  - 方法1：主库启动后，binlog补全即可

    

  - 方法2：Innodb_flush_log_at_trx_commit=1

    > Innodb_flush_log_at_trx_commit参数值说明如下:
    >
    > 0 - 每一秒将修改记录同步到日志(磁盘)中，commit的时候不同步
    >
    > 1 - 每次事务commit都将修改记录同步到日志(磁盘)中
    >
    > 2 - 每次事务commit都将修改写入到操作系统cache中，然后每一秒将修改记录同步写入到日志(磁盘)中

    

  - 方法3：应用程序双写

    

  - 方法4：应用程序写日志

    

  - 方法5：MySQL半同步(semi sync)

 

 

## 从库数据被修改

- 通常报错总结如下

  | ERROR：1032 | 从库找不到要删除的数据                     |
  | ----------- | ------------------------------------------ |
  | ERROR：1062 | 从库插入数据，发生唯一性冲突               |
  | ERROR：1452 | 无法在外键的表插入或更新参考主键没有的数据 |

- 解决与预防

  1. 设置用户权限
  2. 设置从库只读权限 `set global read_only=true`