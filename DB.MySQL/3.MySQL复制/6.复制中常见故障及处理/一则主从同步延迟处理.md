## ã€å·¥ä½œç¬”è®°ã€‘ä¸€åˆ™ä¸»ä»åŒæ­¥å»¶è¿Ÿå¤„ç† 

**ä¸€ã€é—®é¢˜æè¿°**

ä»Šå¤©æ”¶åˆ°ä¸»ä»å»¶è¿Ÿå‘Šè­¦ï¼ˆå‘¨æœ«ç¡äº†ä¸€æ™šä¸Šæ²¡çœ‹åˆ°å‘Šè­¦ï¼Œç•¥æ˜¾å°´å°¬ğŸ˜“ï¼‰ï¼Œèµ¶ç´§çœ‹ä¸‹ä»åº“çŠ¶æ€

[14:50:56 root@mysql3306.sock][(none)]> show slave status\G

*************************** 1. row *************************** 

Slave_IO_State: Waiting for master to send event

Master_Host: 10.100.63.10

Master_User: repl

Master_Port: 3306

Connect_Retry: 60

Master_Log_File: mysql-bin.000383

Read_Master_Log_Pos: 132069756

Relay_Log_File: mlfslave164-relay-bin.000684

Relay_Log_Pos: 827356702 Relay_Master_Log_File: mysql-bin.000382

Slave_IO_Running: Yes  Slave_SQL_Running: Yes

Replicate_Do_DB:

Replicate_Ignore_DB:

Replicate_Do_Table:

Replicate_Ignore_Table:  Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table:

Last_Errno: 0

Last_Error:

Skip_Counter: 0

Exec_Master_Log_Pos: 827356489

Relay_Log_Space: 1205833440

Until_Condition: None

Until_Log_File:

Until_Log_Pos: 0

Master_SSL_Allowed: No

Master_SSL_CA_File:

Master_SSL_CA_Path:

Master_SSL_Cert:  Master_SSL_Cipher:

Master_SSL_Key: Seconds_Behind_Master: 50064Master_SSL_Verify_Server_Cert: No

Last_IO_Errno: 0

Last_IO_Error:

Last_SQL_Errno: 0

Last_SQL_Error: Replicate_Ignore_Server_Ids:

Master_Server_Id: 30429

Master_UUID: d04dc0aa-ca9f-11e8-ba14-d094660e5c57

Master_Info_File: mysql.slave_master_info

SQL_Delay: 0

SQL_Remaining_Delay: NULL  Slave_SQL_Running_State: Reading event from the relay log

Master_Retry_Count: 86400

Master_Bind:  Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp:

Master_SSL_Crl:

Master_SSL_Crlpath:

Retrieved_Gtid_Set:  Executed_Gtid_Set:

Auto_Position: 0  Replicate_Rewrite_DB:

Channel_Name:

Master_TLS_Version:1 row in set (0.00 sec)

 

 

 

**äºŒã€é—®é¢˜è¯Šæ–­**

**2.1 åˆæ­¥åˆ¤æ–­**

showå‡ æ¬¡slave statusçš„ç»“æœçœ‹åˆ°Exec_Master_Log_Poséƒ½å¤„äºä½ç½®827356489ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±å¯ä»¥åˆ¤æ–­å‡ºå¤„äºå¤§äº‹åŠ¡äº†ã€‚




**2.2 è§£æbinlog**

é€šè¿‡è§£æä¸»åº“çš„binlogä¸€æ¢ç©¶ç«Ÿï¼Œ

![ ](.pics/clip_image001-1598930244387.jpg)




![ ](.pics/clip_image002-1598930244387.jpg)





 

**2.3 pstack**

å†çœ‹ä¸‹pstackç»“æœ

çœ‹åˆ°sql_threadå¤„äºrow_search_mvccçŠ¶æ€ï¼Œåˆ°è¿™é‡Œå…¶å®åŸºæœ¬ä¸Šå¯ä»¥åˆ¤æ–­å‡ºç”±äºè¡¨æ²¡æœ‰ä¸»é”®æˆ–è€…æ²¡æœ‰åˆé€‚çš„ç´¢å¼•é€ æˆçš„ä¸»ä»å»¶è¿Ÿã€‚

Thread 217 (Thread 0x7fdf4af5c700 (LWP 180191)):#0

sel_restore_position_for_mysql (same_user_rec=0x7fdf4af5bb48, pcur=0x7fe0546e2718, moves_up=1, mtr=0x7fdf4af5aad0, latch_mode=1) at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/storage/innobase/row/row0sel.cc:3760#1

0x00000000011396b6 in row_search_mvcc (buf=0x7fe05451c5b0 "", mode=PAGE_CUR_G, prebuilt=0x7fe0546e2508, match_mode=0, direction=1) at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/storage/innobase/row/row0sel.cc:5069#2

0x000000000104af2e in ha_innobase::general_fetch (this=0x7fe054c79c60, buf=0x7fe05451c5b0 "", direction=1, match_mode=0) at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/storage/innobase/handler/ha_innodb.cc:9021#3

0x000000000081b9fa in handler::ha_rnd_next (this=<optimized out>, buf=0x7fe05451c5b0 "") at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/sql/handler.cc:2947#4

0x0000000000ecd461 in Rows_log_event::do_table_scan_and_update (this=0x7fe04954d970, rli=0x7fe048085f30) at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/sql/log_event.cc:10804#5

0x0000000000edb4f2 in Rows_log_event::do_apply_event (this=0x7fe04954d970, rli=0x7fe048085f30) at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/sql/log_event.cc:11270#6

0x0000000000f2dbb5 in slave_worker_exec_job_group (worker=0x7fe048085f30, rli=0x7fe01409f450) at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/sql/rpl_rli_pdb.cc:2666#7

0x0000000000f199b3 in handle_slave_worker (arg=0x7fe048085f30) at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/sql/rpl_slave.cc:6180#8

0x0000000000fc79a4 in pfs_spawn_thread (arg=0x7fe04800dfa0) at /export/home/pb2/build/sb_0-29016441-1528454776.43/mysql-5.7.23/storage/perfschema/pfs.cc:2190#9

0x00007feddcd23dd5 in start_thread () from /lib64/libpthread.so.0#10 0x00007feddb7dbead in clone () from /lib64/libc.so.6




**2.4 æ ¹å› ç¡®å®š**

æˆ‘ä»¬å†çœ‹ä¸‹å¯¹åº”çš„è¡¨çš„è¡¨ç»“æœï¼Œä»binlogå¯ä»¥çœ‹åˆ°æ›´æ–°çš„è¡¨ä¸ºdiwo_mydoc_inc$_tempï¼Œè¡¨ç»“æ„å¦‚ä¸‹ï¼š

[20:29:34 root@mysql3306.sock][trswcmtest]> show create table diwo_mydoc_inc$_temp\G

*************************** 1. row ***************************    

Table: diwo_mydoc_inc$_tempCreate 

Table: CREATE TABLE `diwo_mydoc_inc$_temp` ( `SEQ_ID` bigint(20) NOT NULL DEFAULT '0', `viewkey` varchar(37) NOT NULL, 

`SQL_TYPE` tinyint(4) NOT NULL, 

`TRS_FLAG` tinyint(4) NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8

1 row in set (0.00 sec)

æœç„¶ï¼Œå¦‚æˆ‘ä»¬æ‰€æ–™ï¼Œè¡¨ä¸Šæ²¡æœ‰ä¸»é”®ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç´¢å¼•ã€‚


å¥½äº†ï¼Œåˆ°è¿™é‡Œä¸»ä»å»¶è¿Ÿçš„åŸå› å·²ç»æ‰¾åˆ°ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

**ä¸‰ã€è§£å†³åŠæ³•**

**3.1 ç»§ç»­ç­‰å¾…**

è¿™æ˜¯ä¸€ç§å¾ˆæ— å¥ˆçš„æ–¹å¼ï¼Œå•¥éƒ½ä¸åš

 

[20:32:28 root@mysql3306.sock][trswcmtest]> pager cat - |grep "row lock"

PAGER set to 'cat - |grep "row lock"'

[20:32:35 root@mysql3306.sock][trswcmtest]> show engine innodb status\G

 0 lock struct(s), heap size 1136, 0 row lock(s)

 0 lock struct(s), heap size 1136, 0 row lock(s)

 0 lock struct(s), heap size 1136, 0 row lock(s)

 0 lock struct(s), heap size 1136, 0 row lock(s)

 0 lock struct(s), heap size 1136, 0 row lock(s)

 0 lock struct(s), heap size 1136, 0 row lock(s)

 0 lock struct(s), heap size 1136, 0 row lock(s)

 0 lock struct(s), heap size 1136, 0 row lock(s)

 0 lock struct(s), heap size 1136, 0 row lock(s)

1 row in set (0.00 sec)

 

é€šè¿‡è¿™ç§æ–¹å¼æŸ¥çœ‹è¡Œé”çš„æ•°é‡ï¼Œå¯ä»¥ä¼°ç®—å‡ºå¤§æ¦‚è¿˜éœ€è¦å¤šå°‘æ—¶é—´å®Œæˆbinlogåº”ç”¨ï¼ˆå½“æ—¶å¤ªåŒ†å¿™ï¼Œå¿˜è®°æˆªå›¾äº†ï¼‰ï¼Œæ•…éšœå½“æ—¶ç²—ç•¥ä¼°ç®—è¿˜éœ€è¦5ä¸ªå°æ—¶æ‰èƒ½åº”ç”¨å®Œï¼Œæœæ–­ä½¿ç”¨äº†ç¬¬äºŒç§æ–¹æ³•ã€‚



 

**3.2 é‡å¯ã€å»ºç´¢å¼•**

æ­¤æ—¶å¦‚æœæŒ‰æ­£å¸¸shutdownæˆ–è€…stop slaveçš„æ–¹å¼æ¥åœæ­¢å¤åˆ¶éœ€è¦çš„æ—¶é—´å¯èƒ½å·²ç»ä¸æ­¢ä¸€ç‚¹åŠç‚¹äº†ï¼Œè¿‡æ®µkill -9 `pid of mysqld`ï¼Œå¯åŠ¨æ—¶æ·»åŠ å‚æ•°`â€” skip-slave-start`ä¿è¯slaveå¯åŠ¨æ—¶ä¸å¼€å¯å¤åˆ¶ã€‚

è§‚å¯Ÿè¡¨diwo_mydoc_inc$_tempçš„æ•°æ®åˆ†å¸ƒï¼Œå‘ç°viewkeyå­—æ®µæ¥æºäºå¦å¤–ä¸¤å¼ è¡¨çš„â€è¡¨åâ€+å”¯ä¸€é”®ï¼ŒSQL_TYPEå­—æ®µæ ‡è¯†äº†SQLçš„ç±»å‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¯¹viewkeyå»ºç«‹ç´¢å¼•ï¼Œä¸”åŒºåˆ†åº¦è¾ƒé«˜ã€‚

- set     sql_log_bin=0;
- create     index idx_viewkey on diwo_mydoc_inc$_temp(viewkey);

å»ºç«‹ç´¢å¼•ä»¥åï¼Œå†å¼€å¯å¤åˆ¶ï¼Œ2åˆ†é’Ÿä»¥åå°±è¿½ä¸Šäº†ä¸»åº“ï¼Œå¯è§å¤åˆ¶è¿˜æ˜¯å¾ˆç»™åŠ›çš„ã€‚




**3.3 ä¿®æ”¹slave_rows_search_algorithms**

slave_rows_search_algorithmsé»˜è®¤å€¼ä¸ºTABLE_SCAN,INDEX_SCANï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®HASH_SCANæ¥åŠ é€Ÿbinlog eventåœ¨åº”ç”¨è¿‡ç¨‹ä¸­çš„rowå®šä½ã€‚HASH_SCANæé«˜æ€§èƒ½çš„ä¸¤ä¸ªæ¡ä»¶å¦‚ä¸‹ï¼š

1. è¡¨ä¸­æ²¡æœ‰ä»»ä½•ç´¢å¼•æˆ–è€…æœ‰ç´¢å¼•ä¸”æœ¬æ¡update/deleteçš„æ•°æ®å…³é”®å­—é‡å¤å€¼è¾ƒå¤š
2. ä¸€ä¸ªupdate/deleteè¯­å¥åˆ é™¤äº†å¤§é‡çš„æ•°æ®ï¼Œå½¢æˆäº†å¾ˆå¤šä¸ª8Kå·¦å³çš„UPDATE_ROW_EVENT/DELETE_ROW_EVENTã€‚update/deleteåªä¿®æ”¹å°‘é‡çš„æ•°æ®ï¼ˆæ¯”å¦‚æ¯ä¸ªè¯­å¥ä¿®æ”¹ä¸€è¡Œæ•°æ®ï¼‰å¹¶ä¸èƒ½æé«˜æ€§èƒ½




**å››ã€æ€è€ƒ**

åˆ°è¿™é‡Œï¼Œé—®é¢˜å·²è§£å†³å¤§åŠï¼Œä½†æ˜¯ç»™æˆ‘ä»¬çš„è­¦ç¤ºè¿˜å¾—ç‰¢è®°äºå¿ƒ

1. å¤§äº‹åŠ¡ï¼Œä¸»ä»å¤åˆ¶é€ æˆå»¶è¿Ÿçš„ç½ªé­ç¥¸é¦–
2. æ— ä¸»é”®ã€å”¯ä¸€é”®ï¼Œä¸»ä»å»¶è¿Ÿçš„å‚¬åŒ–å‰‚ï¼Œå»ºè®®æ¯ä¸ªè¡¨è¿˜æ˜¯ä¿ç•™è‡ªå¢ä¸»é”®ä»¥æé«˜å¤åˆ¶æ€§èƒ½
3. æœ¬æ–‡ç»™å‡ºäº†å¿«é€Ÿè¯Šæ–­ä¸»ä»å»¶è¿Ÿçš„æ€è·¯åŠæ–¹æ³•ï¼Œå»ºè®®æ–°æ‰‹æœ‹å‹ä»¬å¯ä»¥å­¦ä¹ ä¸€ä¸‹è¿™ä¸ªå¥—è·¯ 