通过搭建MHA一主两从架构来理解搭建、配置、原理

# 目录：

[TOC]




# MHA搭建

环境规划：

CentOS 7.7 x86_64

> *CentOS 6 -- v0.56 mha*
>
> CentOS 7 -- v0.58 mha

| 192.168.188.201    | mysqlvm1-1 | master  | mha node     |
| ------------------ | ---------- | ------- | ------------ |
| 192.168.188.202    | mysqlvm1-2 | slave1  | mha node     |
| 192.168.188.203    | mysqlvm1-3 | slave2  | mha node     |
| 192.168.188.204    | mysqlvm1-4 | mha mng | mha  manager |
| 192.168.188.222/32 | --         | vip     | --           |

 

- 为什么VIP要用32位掩码?

  当VIP的掩码设置成32位时，VIP只能被连接，不会主动去连接别的IP。这是由“路由表”决定的。

  - 想一想VIP的使用——

    VIP是为了“提供服务”的。不是用于“获取服务”的。所以，VIP掩码为32位，可以防止VIP漂移时，有附带伤害。

  - 另外，在LVS应用上，假如VIP掩码不是32位，那么，健康检查有可用VIP是连接RS进行检查（RS上了有VIP地址的配置），这时，健康检查就会失改，引起集群工作不正常。

- 其实可以多个VIP，一个负责写操作，一个负责读操作。

 

- MHA包信息：

  ```
  mha4mysql-manager-0.58-0.el7.centos.noarch.rpm
  mha4mysql-node-0.58-0.el7.centos.noarch.rpm
  
  *配置文件及脚本sample、rpm包及源码，可从Github获取 
  *MHA@Github:https://github.com/yoshinorim/mha4mysql-manager
  ```

  

- 依赖：

  ```
  perl-DBD-MySQL
  perl-Email-Date-Format-1.002-15.el7.noarch.rpm
  perl-Log-Dispatch-2.41-1.el7.1.noarch.rpm
  perl-MIME-Lite-3.030-1.el7.noarch.rpm
  perl-MIME-Types-1.38-2.el7.noarch.rpm
  perl-Mail-Sender-0.8.23-1.el7.noarch.rpm
  perl-Mail-Sendmail-0.79-21.el7.noarch.rpm
  perl-Parallel-ForkManager-1.18-2.el7.noarch.rpm
  ```

  *perl部分依赖从EPEL源我下载也有问题，可以直接在https://pkgs.org/ 搜索并直接获得下载地址。

  

- 安装：

  ```
  [ALL]# yum install epel-release 
  
  [ALL]# yum install perl-DBD-MySQL \
  perl-Config-Tiny \
perl-Log-Dispatch \
  perl-Parallel-ForkManager \
  perl-Time-HiRes

  # 装manager之前一定要装node，不然会缺失依赖。
  [ALL]# yum localinstall mha4mysql-node-0.58-0.el7.centos.noarch.rpm
  [mysqlvm1-4]# yum localinstall mha4mysql-manager-0.58-0.el7.centos.noarch.rpm
  ```
  
  - 将脚本和配置文件上传到服务器，或直接创建
  - 脚本及配置文件可参照sample，或github 上直接获取sample
  
  
  
  
  
  

## 配置主从复制，并启用半同步

步骤略，可走[传送门：MySQL 复制环境搭建](..\..\3.MySQL复制\8.复制搭建实验\2.实验：GTID环境利用xtrabackup搭建一个增强半同步从库.md)




# MHA manager各脚本功能

- 各脚本功能（预留）

| masterha_check_ssh       | 检查MHA的SSH配置状况                                         |
| ------------------------ | ------------------------------------------------------------ |
| masterha_check_repl      | 检查MySQL各节点复制状态                                      |
| masterha_check_status    | 检测当前MHA Manager运行状态                                  |
| masterha_manger          | 开启 MHA Manager                                             |
| masterha_stop            | 停止MHA                                                      |
| masterha_master_switch   | 控制故障转移（可手动）                                       |
| masterha_conf_host       | 添加或者删除配置的server信息                                 |
| master_ip_failover       | 自动切换时管理vip的脚本，主要是VIP的漂移。                   |
| master_ip_online_change  | 手动执行mysql master  switchover时执行的切换脚本,含有管理vip的脚本 |
| masterha_master_monitor  | 检测master是否宕机                                           |
| masterha_secondary_check |                                                              |

- 自定义脚本

| init_vip.sh | 绑定VIP |
| ----------- | ------- |
| drop_vip.sh | 解绑VIP |

  ```
# init_vip.sh
vip="172.18.0.155/32"
/sbin/ip addr add $vip dev eth0
  ```

```
# drop_vip.sh
vip="172.18.0.155/32"
/sbin/ip addr del $vip dev eth0
```



# MHA常用命令

- MHA manager常用命令（预留）

| role       | commands                                                     |
| ---------- | ------------------------------------------------------------ |
| failover   | masterha_master_switch --master_state=dead --global_conf=xxx  --conf=xxx --dead_master_host=$host *--dead_master_port=* *--new_master_host=* *--new_master_port=* *--ignore_last_failover* |
| switchover | masterha_master_switch  --master_state=alive --global_conf=xxx conf=xxx  *--running_updates_limit=* *-* *-orig_master_is_new_slave* |
|            |                                                              |

 

# MHA配置

1.  配置操作系统SSH互信

    这个步骤也略吧，太简单了。

2. 配置MHA

   ```
   [root@mysqlvm1-4 masterha]# chmod +x *.sh
   [root@mysqlvm1-4 masterha]# ll
   total 32
   -rw-r--r--. 1 root root  499 Mar 14 20:25 app1.cnf
   -rwxr-xr-x. 1 root root  59 Mar 14 20:29 drop_vip.sh
   -rwxr-xr-x. 1 root root  59 Mar 14 20:29 init_vip.sh
   -rw-r--r--. 1 root root  506 Mar 14 20:05 masterha_default.cnf
   -rwxr-xr-x. 1 root root 3981 Mar 14 20:31 master_ip_failover
   -rwxr-xr-x. 1 root root 10393 Mar 14 20:31 master_ip_online_change
   ```

3. 检查SSH互信

   ```
   [root@mysqlvm1-4 masterha]# masterha_check_ssh --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf 
   ```

   ```
   Sat Mar 14 20:32:58 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..
   Sat Mar 14 20:32:58 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..
   Sat Mar 14 20:32:58 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..
   Sat Mar 14 20:32:58 2020 - [info] Starting SSH connection tests..
   Sat Mar 14 20:33:01 2020 - [debug] 
   Sat Mar 14 20:32:59 2020 - [debug] Connecting via SSH from root@192.168.188.203(192.168.188.203:22) to root@192.168.188.201(192.168.188.201:22)..
   Sat Mar 14 20:33:00 2020 - [debug]  ok.
   Sat Mar 14 20:33:00 2020 - [debug] Connecting via SSH from root@192.168.188.203(192.168.188.203:22) to root@192.168.188.202(192.168.188.202:22)..
   Warning: Permanently added '192.168.188.202' (ECDSA) to the list of known hosts.
   Sat Mar 14 20:33:01 2020 - [debug]  ok.
   Sat Mar 14 20:33:01 2020 - [debug] 
   Sat Mar 14 20:32:59 2020 - [debug] Connecting via SSH from root@192.168.188.202(192.168.188.202:22) to root@192.168.188.201(192.168.188.201:22)..
   Sat Mar 14 20:32:59 2020 - [debug]  ok.
   Sat Mar 14 20:32:59 2020 - [debug] Connecting via SSH from root@192.168.188.202(192.168.188.202:22) to root@192.168.188.203(192.168.188.203:22)..
   Warning: Permanently added '192.168.188.203' (ECDSA) to the list of known hosts.
   Sat Mar 14 20:33:00 2020 - [debug]  ok.
   Sat Mar 14 20:33:01 2020 - [debug] 
   Sat Mar 14 20:32:58 2020 - [debug] Connecting via SSH from root@192.168.188.201(192.168.188.201:22) to root@192.168.188.202(192.168.188.202:22)..
   Sat Mar 14 20:32:59 2020 - [debug]  ok.
   Sat Mar 14 20:32:59 2020 - [debug] Connecting via SSH from root@192.168.188.201(192.168.188.201:22) to root@192.168.188.203(192.168.188.203:22)..
   Sat Mar 14 20:33:00 2020 - [debug]  ok.
   Sat Mar 14 20:33:01 2020 - [info] All SSH connection tests passed successfully.
   
   [root@mysqlvm1-4 masterha]# 
   ```

4. 检查复制状态

   ```
   [root@mysqlvm1-4 masterha]# masterha_check_repl --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf 
   ```

   ```
   Sat Mar 14 20:34:07 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..
   Sat Mar 14 20:34:07 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..
   Sat Mar 14 20:34:07 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..
   Sat Mar 14 20:34:07 2020 - [info] MHA::MasterMonitor version 0.58.
   Creating directory /var/log/masterha/app1.. done.
   Sat Mar 14 20:34:08 2020 - [info] GTID failover mode = 1
   Sat Mar 14 20:34:08 2020 - [info] Dead Servers:
   Sat Mar 14 20:34:08 2020 - [info] Alive Servers:
   Sat Mar 14 20:34:08 2020 - [info]  192.168.188.201(192.168.188.201:3306)
   Sat Mar 14 20:34:08 2020 - [info]  192.168.188.202(192.168.188.202:3306)
   Sat Mar 14 20:34:08 2020 - [info]  192.168.188.203(192.168.188.203:3306)
   Sat Mar 14 20:34:08 2020 - [info] Alive Slaves:
   Sat Mar 14 20:34:08 2020 - [info]  192.168.188.202(192.168.188.202:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
   Sat Mar 14 20:34:08 2020 - [info]   GTID ON
   Sat Mar 14 20:34:08 2020 - [info]   Replicating from 192.168.188.201(192.168.188.201:3306)
   Sat Mar 14 20:34:08 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
   Sat Mar 14 20:34:08 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
   Sat Mar 14 20:34:08 2020 - [info]   GTID ON
   Sat Mar 14 20:34:08 2020 - [info]   Replicating from 192.168.188.201(192.168.188.201:3306)
   Sat Mar 14 20:34:08 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
   Sat Mar 14 20:34:08 2020 - [info] Current Alive Master: 192.168.188.201(192.168.188.201:3306)
   Sat Mar 14 20:34:08 2020 - [info] Checking slave configurations..
   Sat Mar 14 20:34:08 2020 - [info] read_only=1 is not set on slave 192.168.188.202(192.168.188.202:3306).
   Sat Mar 14 20:34:08 2020 - [info] read_only=1 is not set on slave 192.168.188.203(192.168.188.203:3306).
   Sat Mar 14 20:34:08 2020 - [info] Checking replication filtering settings..
   Sat Mar 14 20:34:08 2020 - [info] binlog_do_db= , binlog_ignore_db= 
   Sat Mar 14 20:34:08 2020 - [info] Replication filtering check ok.
   Sat Mar 14 20:34:08 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.
   Sat Mar 14 20:34:08 2020 - [info] Checking SSH publickey authentication settings on the current master..
   Sat Mar 14 20:34:08 2020 - [info] HealthCheck: SSH to 192.168.188.201 is reachable.
   Sat Mar 14 20:34:08 2020 - [info] 
   192.168.188.201(192.168.188.201:3306) (current master)
    +--192.168.188.202(192.168.188.202:3306)
    +--192.168.188.203(192.168.188.203:3306)
   
   Sat Mar 14 20:34:08 2020 - [info] Checking replication health on 192.168.188.202..
   Sat Mar 14 20:34:08 2020 - [info] ok.
   Sat Mar 14 20:34:08 2020 - [info] Checking replication health on 192.168.188.203..
   Sat Mar 14 20:34:08 2020 - [info] ok.
   Sat Mar 14 20:34:08 2020 - [info] Checking master_ip_failover_script status:
   Sat Mar 14 20:34:08 2020 - [info]  /etc/masterha/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.188.201 --orig_master_ip=192.168.188.201 --orig_master_port=3306 
   Sat Mar 14 20:34:08 2020 - [info] OK.
   Sat Mar 14 20:34:08 2020 - [warning] shutdown_script is not defined.
   Sat Mar 14 20:34:08 2020 - [info] Got exit code 0 (Not master dead).
   
   **MySQL Replication Health is OK.**    ——出这个才代表复制检查通过！
   ```

5. 启用MHA manager

   都检查通过了， 就可以启动MHA manager了。

   - 首先在master上绑定VIP

     ```
     [root@mysqlvm1-4 masterha]# init_vip.sh
     
     [root@mysqlvm1-4 masterha]# nohup masterha_manager --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf &
     [1] 1720
     
     [root@mysqlvm1-4 masterha]# ll
     total 36
     -rw-r--r--. 1 root root  499 Mar 14 20:25 app1.cnf
     -rwxr-xr-x. 1 root root  59 Mar 14 20:29 drop_vip.sh
     -rwxr-xr-x. 1 root root  59 Mar 14 20:29 init_vip.sh
     -rw-r--r--. 1 root root  506 Mar 14 20:05 masterha_default.cnf
     -rwxr-xr-x. 1 root root 3981 Mar 14 20:31 master_ip_failover
     -rwxr-xr-x. 1 root root 10393 Mar 14 20:31 master_ip_online_change
     -rw-------. 1 root root  305 Mar 14 20:38 nohup.out
     
     [root@mysqlvm1-4 masterha]# cat nohup.out 
     Sat Mar 14 20:38:35 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..
     Sat Mar 14 20:38:35 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..
     Sat Mar 14 20:38:35 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..
     ```

     由于乱玩，做了一次failover之后，MHA Manager便完成failover后退出了（这是MHA默认的...特性。）。重新将原master作为slave加入复制结构后，重启MHA Manager，继续实验。

 

6. 检查MHA状态

   ```
   [root@mysqlvm1-4 masterha]# masterha_check_status --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf 
   app1 (pid:1719) is running(0:PING_OK), master:192.168.188.202
   
   [root@mysqlvm1-4 masterha]# ssh 192.168.188.222
   Last login: Sun Mar 15 06:18:09 2020 from 192.168.188.1
   
   [root@mysqlvm1-2 ~]# 
   ```

   - 可知，VIP目前在节点2上， master是节点2噢。

 这就完事了。

 

 

7. 再玩一次failover

   - 首先，给目前的master产生一些事务，保持事务持续产生。

   - 然后检查下MHA状态

     ```
     [root@mysqlvm1-4 masterha]# masterha_check_status --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf 
     app1 (pid:1719) is running(0:PING_OK), master:192.168.188.202
     ```

   - 再检查下复制状态

     ```
     [root@mysqlvm1-4 masterha]# masterha_check_repl --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf 
     Sun Mar 15 06:54:14 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..
     Sun Mar 15 06:54:14 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..
     Sun Mar 15 06:54:14 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..
     Sun Mar 15 06:54:14 2020 - [info] MHA::MasterMonitor version 0.58.
     Sun Mar 15 06:54:15 2020 - [info] GTID failover mode = 1
     Sun Mar 15 06:54:15 2020 - [info] Dead Servers:
     Sun Mar 15 06:54:15 2020 - [info] Alive Servers:
     Sun Mar 15 06:54:15 2020 - [info]  192.168.188.201(192.168.188.201:3306)
     Sun Mar 15 06:54:15 2020 - [info]  192.168.188.202(192.168.188.202:3306)
     Sun Mar 15 06:54:15 2020 - [info]  192.168.188.203(192.168.188.203:3306)
     Sun Mar 15 06:54:15 2020 - [info] Alive Slaves:
     Sun Mar 15 06:54:15 2020 - [info]  192.168.188.201(192.168.188.201:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
     Sun Mar 15 06:54:15 2020 - [info]   GTID ON
     Sun Mar 15 06:54:15 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
     Sun Mar 15 06:54:15 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
     Sun Mar 15 06:54:15 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
     Sun Mar 15 06:54:15 2020 - [info]   GTID ON
     Sun Mar 15 06:54:15 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
     Sun Mar 15 06:54:15 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
     Sun Mar 15 06:54:15 2020 - [info] Current Alive Master: 192.168.188.202(192.168.188.202:3306)
     Sun Mar 15 06:54:15 2020 - [info] Checking slave configurations..
     Sun Mar 15 06:54:15 2020 - [info] Checking replication filtering settings..
     Sun Mar 15 06:54:15 2020 - [info] binlog_do_db= , binlog_ignore_db= 
     Sun Mar 15 06:54:15 2020 - [info] Replication filtering check ok.
     Sun Mar 15 06:54:15 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.
     Sun Mar 15 06:54:15 2020 - [info] Checking SSH publickey authentication settings on the current master..
     Sun Mar 15 06:54:15 2020 - [info] HealthCheck: SSH to 192.168.188.202 is reachable.
     Sun Mar 15 06:54:15 2020 - [info] 
     192.168.188.202(192.168.188.202:3306) (current master)
      +--192.168.188.201(192.168.188.201:3306)
      +--192.168.188.203(192.168.188.203:3306)
      
     Sun Mar 15 06:54:15 2020 - [info] Checking replication health on 192.168.188.201..
     Sun Mar 15 06:54:15 2020 - [info] ok.
     Sun Mar 15 06:54:15 2020 - [info] Checking replication health on 192.168.188.203..
     Sun Mar 15 06:54:15 2020 - [info] ok.
     Sun Mar 15 06:54:15 2020 - [info] Checking master_ip_failover_script status:
     Sun Mar 15 06:54:15 2020 - [info]  /etc/masterha/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.188.202 --orig_master_ip=192.168.188.202 --orig_master_port=3306 
     Sun Mar 15 06:54:15 2020 - [info] OK.
     Sun Mar 15 06:54:15 2020 - [warning] shutdown_script is not defined.
     Sun Mar 15 06:54:15 2020 - [info] Got exit code 0 (Not master dead).
      
     MySQL Replication Health is OK.
     ```



# MHA切换初试

1.  现在，贱贱的去把当前master shutdown。

2. 然后随手看了下节点3的slave状态，已经failover到节点1了噢。

   ```
   mysql> show slave status\G
   *************************** 1. row ***************************
           Slave_IO_State: Waiting for master to send event
            Master_Host: 192.168.188.201
   ```

3. 然后发现MHA manager自动退出啦

   ```
   [root@mysqlvm1-4 masterha]# 
   [1]+ Done          nohup masterha_manager --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf
   ```

4. VIP也漂移到节点1了

   ```
   [root@mysqlvm1-4 masterha]# ping 192.168.188.222
   PING 192.168.188.222 (192.168.188.222) 56(84) bytes of data.
   64 bytes from 192.168.188.222: icmp_seq=10 ttl=64 time=1.28 ms
   64 bytes from 192.168.188.222: icmp_seq=11 ttl=64 time=0.606 ms
   [root@mysqlvm1-4 masterha]# ssh !$
   ssh 192.168.188.222
   Last login: Sun Mar 15 06:18:09 2020 from 192.168.188.1
   [root@mysqlvm1-1 ~]# 
   ```

5. 节点1 slave信息被清除

   ```
   mysql> show slave status \G
   Empty set (0.00 sec)
   ```

6. 查看一下MHA manager的日志

   可以从这里了解MHA的切换流程，从而学习原理。

    ```
   [root@mysqlvm1-4 app1]# pwd
   /var/log/masterha/app1
   
   [root@mysqlvm1-4 app1]# ll
   total 36
   -rw-r--r--. 1 root root   0 Mar 15 06:56 app1.failover.complete
   -rw-r--r--. 1 root root 34217 Mar 15 06:56 manager.log
    ```

   



 

# MHA原理初试（via app日志）

```
cat manager.log
Sun Mar 15 06:23:59 2020 - [info] MHA::MasterMonitor version 0.58.
Sun Mar 15 06:24:00 2020 - [info] GTID failover mode = 1
Sun Mar 15 06:24:00 2020 - [info] Dead Servers:
Sun Mar 15 06:24:00 2020 - [info] Alive Servers:
Sun Mar 15 06:24:00 2020 - [info]  192.168.188.201(192.168.188.201:3306)
Sun Mar 15 06:24:00 2020 - [info]  192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:24:00 2020 - [info]  192.168.188.203(192.168.188.203:3306)
Sun Mar 15 06:24:00 2020 - [info] Alive Slaves:
Sun Mar 15 06:24:00 2020 - [info]  192.168.188.201(192.168.188.201:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:24:00 2020 - [info]   GTID ON
Sun Mar 15 06:24:00 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:24:00 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:24:00 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:24:00 2020 - [info]   GTID ON
Sun Mar 15 06:24:00 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:24:00 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:24:00 2020 - [info] Current Alive Master: 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:24:00 2020 - [info] Checking slave configurations..
Sun Mar 15 06:24:00 2020 - [info] Checking replication filtering settings..
Sun Mar 15 06:24:00 2020 - [info] binlog_do_db= , binlog_ignore_db= 
Sun Mar 15 06:24:00 2020 - [info] Replication filtering check ok.
Sun Mar 15 06:24:00 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.
Sun Mar 15 06:24:00 2020 - [info] Checking SSH publickey authentication settings on the current master..
Sun Mar 15 06:24:01 2020 - [info] HealthCheck: SSH to 192.168.188.202 is reachable.
Sun Mar 15 06:24:01 2020 - [info] 
192.168.188.202(192.168.188.202:3306) (current master)
 +--192.168.188.201(192.168.188.201:3306)
 +--192.168.188.203(192.168.188.203:3306)
 
Sun Mar 15 06:24:01 2020 - [info] Checking master_ip_failover_script status:
Sun Mar 15 06:24:01 2020 - [info]  **/etc/masterha/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.188.202 --orig_master_ip=192.168.188.202 --orig_master_port=3306** 
Sun Mar 15 06:24:01 2020 - [info] OK.
Sun Mar 15 06:24:01 2020 - [warning] shutdown_script is not defined.
Sun Mar 15 06:24:01 2020 - [info] Set master ping interval 3 seconds.
Sun Mar 15 06:24:01 2020 - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.
Sun Mar 15 06:24:01 2020 - [info] Starting ping health check on 192.168.188.202(192.168.188.202:3306)..
Sun Mar 15 06:24:01 2020 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond..
Sun Mar 15 06:56:16 2020 - [warning] Got error on MySQL select ping: 2006 (MySQL server has gone away)
Sun Mar 15 06:56:16 2020 - [info] Executing SSH check script: exit 0
Sun Mar 15 06:56:16 2020 - [info] HealthCheck: SSH to 192.168.188.202 is reachable.
Sun Mar 15 06:56:19 2020 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '192.168.188.202' (111))
Sun Mar 15 06:56:19 2020 - [warning] Connection failed 2 time(s)..
Sun Mar 15 06:56:22 2020 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '192.168.188.202' (111))
Sun Mar 15 06:56:22 2020 - [warning] Connection failed 3 time(s)..
Sun Mar 15 06:56:25 2020 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '192.168.188.202' (111))
Sun Mar 15 06:56:25 2020 - [warning] Connection failed 4 time(s)..
Sun Mar 15 06:56:25 2020 - [warning] Master is not reachable from health checker!
Sun Mar 15 06:56:25 2020 - [warning] Master 192.168.188.202(192.168.188.202:3306) is not reachable!
Sun Mar 15 06:56:25 2020 - [warning] SSH is reachable.
Sun Mar 15 06:56:25 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/masterha_default.cnf and /etc/masterha/app1.cnf again, and trying to connect to all servers to check server status..
Sun Mar 15 06:56:25 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..
Sun Mar 15 06:56:25 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..
Sun Mar 15 06:56:25 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..
Sun Mar 15 06:56:26 2020 - [info] GTID failover mode = 1
Sun Mar 15 06:56:26 2020 - [info] Dead Servers:
Sun Mar 15 06:56:26 2020 - [info]  192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:26 2020 - [info] Alive Servers:
Sun Mar 15 06:56:26 2020 - [info]  192.168.188.201(192.168.188.201:3306)
Sun Mar 15 06:56:26 2020 - [info]  192.168.188.203(192.168.188.203:3306)
Sun Mar 15 06:56:26 2020 - [info] Alive Slaves:
Sun Mar 15 06:56:26 2020 - [info]  192.168.188.201(192.168.188.201:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:56:26 2020 - [info]   GTID ON
Sun Mar 15 06:56:26 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:26 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:56:26 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:56:26 2020 - [info]   GTID ON
Sun Mar 15 06:56:26 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:26 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:56:26 2020 - [info] Checking slave configurations..
Sun Mar 15 06:56:26 2020 - [info] Checking replication filtering settings..
Sun Mar 15 06:56:26 2020 - [info] Replication filtering check ok.
Sun Mar 15 06:56:26 2020 - [info] Master is down!
Sun Mar 15 06:56:26 2020 - [info] Terminating monitoring script.
Sun Mar 15 06:56:26 2020 - [info] Got exit code 20 (Master dead).
Sun Mar 15 06:56:26 2020 - [info] MHA::MasterFailover version 0.58.
Sun Mar 15 06:56:26 2020 - [info] Starting master failover.
Sun Mar 15 06:56:26 2020 - [info] 
Sun Mar 15 06:56:26 2020 - [info] * Phase 1: Configuration Check Phase..
Sun Mar 15 06:56:26 2020 - [info] 
# Phase 1:
# 检查配置，
# 启用GTID恢复模式（如果可用的话）
# 检查两次master（然后确认master真的一去不复返了）
# 检查存活节点
# 节点数据库版本
# logbin是否开启
# GTID是否开启
# 节点当前复制源
# 是否存在candidate_master=1的节点

Sun Mar 15 06:56:27 2020 - [info] GTID failover mode = 1
Sun Mar 15 06:56:27 2020 - [info] Dead Servers:
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:27 2020 - [info] Checking master reachability via MySQL(double check)...
Sun Mar 15 06:56:27 2020 - [info] ok.
Sun Mar 15 06:56:27 2020 - [info] Alive Servers:
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.201(192.168.188.201:3306)
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.203(192.168.188.203:3306)
Sun Mar 15 06:56:27 2020 - [info] Alive Slaves:
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.201(192.168.188.201:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:56:27 2020 - [info]   GTID ON
Sun Mar 15 06:56:27 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:27 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:56:27 2020 - [info]   GTID ON
Sun Mar 15 06:56:27 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:27 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:56:27 2020 - [info] Starting GTID based failover.
# 开始基于GTID的failover



Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] ** Phase 1: Configuration Check Phase completed.
Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] * Phase 2: Dead Master Shutdown Phase..
#  Phase 2
# /etc/masterha/master_ip_failover --orig_master_host=192.168.188.202 --orig_master_ip=192.168.188.202 --orig_master_port=3306 --command=stopssh --ssh_user=root   



Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] Forcing shutdown so that applications never connect to the current master..
Sun Mar 15 06:56:27 2020 - [info] Executing master IP deactivation script:
Sun Mar 15 06:56:27 2020 - [info**]**  **/etc/masterha/master_ip_failover --orig_master_host=192.168.188.202 --orig_master_ip=192.168.188.202 --orig_master_port=3306 --command=stopssh --ssh_user=root** 
Sun Mar 15 06:56:27 2020 - [info] done.
Sun Mar 15 06:56:27 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.
Sun Mar 15 06:56:27 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.
Sun Mar 15 06:56:27 2020 - [info] 



Sun Mar 15 06:56:27 2020 - [info] * Phase 3: Master Recovery Phase..
Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..
# 找slave同步的位置，然后作为补日志的依据，去补日志。
#		最后的binlog file
#		GTID sets



Sun Mar 15 06:56:27 2020 - [info] 
*Sun Mar 15 06:56:27 2020 - [info] The* *latest binary log file/position on all slaves is mysql-bin.000006:14096*
*Sun Mar 15 06:56:27 2020 - [info] Retrieved Gtid Set: 655ed904-65e7-11ea-82db-000c299aa4ae:1-42*
*Sun Mar 15 06:56:27 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):*
*Sun Mar 15 06:56:27 2020 - [info]  192.168.188.201(192.168.188.201:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled*
*Sun Mar 15 06:56:27 2020 - [info]   GTID ON*
*Sun Mar 15 06:56:27 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)*
*Sun Mar 15 06:56:27 2020 - [info]   Primary candidate for the new Master (candidate_master is set)*
*Sun Mar 15 06:56:27 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled*
*Sun Mar 15 06:56:27 2020 - [info]   GTID ON*
*Sun Mar 15 06:56:27 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)*
*Sun Mar 15 06:56:27 2020 - [info]   Primary candidate for the new Master (candidate_master is set)*
Sun Mar 15 06:56:27 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000006:14096
Sun Mar 15 06:56:27 2020 - [info] Retrieved Gtid Set: 655ed904-65e7-11ea-82db-000c299aa4ae:1-42
Sun Mar 15 06:56:27 2020 - [info] Oldest slaves:
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.201(192.168.188.201:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:56:27 2020 - [info]   GTID ON
Sun Mar 15 06:56:27 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:27 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:56:27 2020 - [info]   GTID ON
Sun Mar 15 06:56:27 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:27 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] * Phase 3.3: Determining New Master Phase..
# Phase 3.3
# （我觉得这个应该是3.2）
# 选举新的master
# 由于是GTID+增强半同步，所以slave之间进度相同，选举策略会进行到哪个节点靠前，就由哪个节点当选。/*探索点：这个顺序，是按照IP顺序，还是按照配置文件中的配置顺序？ 我觉得是根据配置文件中的顺序来进行的，回头实验一下。*/


# 新master当选后， 调整架构为新master+slave。
	


Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] Searching new master from slaves..
Sun Mar 15 06:56:27 2020 - [info] Candidate masters from the configuration file:
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.201(192.168.188.201:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:56:27 2020 - [info]   GTID ON
Sun Mar 15 06:56:27 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:27 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:56:27 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Sun Mar 15 06:56:27 2020 - [info]   GTID ON
Sun Mar 15 06:56:27 2020 - [info]   Replicating from 192.168.188.202(192.168.188.202:3306)
Sun Mar 15 06:56:27 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Sun Mar 15 06:56:27 2020 - [info] Non-candidate masters:
Sun Mar 15 06:56:27 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..
Sun Mar 15 06:56:27 2020 - [info] New master is 192.168.188.201(192.168.188.201:3306)
Sun Mar 15 06:56:27 2020 - [info] Starting master failover..
Sun Mar 15 06:56:27 2020 - [info] 
From:
192.168.188.202(192.168.188.202:3306) (current master)
 +--192.168.188.201(192.168.188.201:3306)
 +--192.168.188.203(192.168.188.203:3306)
 
To:
192.168.188.201(192.168.188.201:3306) (new master)
 +--192.168.188.203(192.168.188.203:3306)
Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] * Phase 3.3: New Master Recovery Phase..
# Phase 3.3
# 此时，新的master和slave（由于增强半同步的架构），数据具备一致性，但这两个角色的数据和原master未必是一致的（因为考虑到非增强半同步等其他情况）——这时，便要进行master恢复。
# 从前面获取的all slave node bin-log filename和 position ，去原master上（与master的binlog）对比。 并在新master上追加差异bin-log。
# New Master Phase阶段，会对新master进行（日志及数据）补偿
# 传送门：MHA_node:save_binary_logs
	
# 追加完差异binlog后，记录下新master的binlog信息:filename，position。
# 所有当前slave，change master to 新master。
	





Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] Waiting all logs to be applied.. 
Sun Mar 15 06:56:27 2020 - [info]  done.
Sun Mar 15 06:56:27 2020 - [info] Getting new master's binlog name and position..
Sun Mar 15 06:56:27 2020 - [info]  mysql-bin.000004:13886
Sun Mar 15 06:56:27 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='192.168.188.201', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='rep', MASTER_PASSWORD='xxx';
Sun Mar 15 06:56:27 2020 - [info] Master Recovery succeeded. [File:Pos:Exec_Gtid_Set](File://Pos:Exec_Gtid_Set): mysql-bin.000004, 13886, 5ee7fdc6-65e7-11ea-9406-000c2950e14e:1-305,
655ed904-65e7-11ea-82db-000c299aa4ae:1-42

#执行脚本
# /etc/masterha/master_ip_failover --command=start --ssh_user=root --orig_master_host=192.168.188.202 --orig_master_ip=192.168.188.202 --orig_master_port=3306 --new_master_host=192.168.188.201 --new_master_ip=192.168.188.201 --new_master_port=3306 --new_master_user='kk'   --new_master_password=xxx
# Set read_only=0 on the new master.



Sun Mar 15 06:56:27 2020 - [info] Executing master IP activate script:
Sun Mar 15 06:56:27 2020 - [info]  **/etc/masterha/master_ip_failover --command=start --ssh_user=root --orig_master_host=192.168.188.202 --orig_master_ip=192.168.188.202 --orig_master_port=3306 --new_master_host=192.168.188.201 --new_master_ip=192.168.188.201 --new_master_port=3306 --new_master_user='kk'  --new_master_password=xxx**
**Set read_only=0 on the new master.**
Sun Mar 15 06:56:27 2020 - [info] OK.
Sun Mar 15 06:56:27 2020 - [info] ** Finished master recovery successfully.

# 此时，主从切换failover便已经完成了。

Sun Mar 15 06:56:27 2020 - [info] * Phase 3: Master Recovery Phase completed.
Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] * Phase 4: Slaves Recovery Phase..
Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] * Phase 4.1: Starting Slaves in parallel..
Sun Mar 15 06:56:27 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] -- Slave recovery on host 192.168.188.203(192.168.188.203:3306) started, pid: 2495. Check tmp log /var/log/masterha/app1/192.168.188.203_3306_20200315065626.log if it takes time..
Sun Mar 15 06:56:28 2020 - [info] 
Sun Mar 15 06:56:28 2020 - [info] Log messages from 192.168.188.203 ...
Sun Mar 15 06:56:28 2020 - [info] 
Sun Mar 15 06:56:27 2020 - [info] Resetting slave 192.168.188.203(192.168.188.203:3306) and starting replication from the new master 192.168.188.201(192.168.188.201:3306)..
Sun Mar 15 06:56:28 2020 - [info] Executed CHANGE MASTER.
Sun Mar 15 06:56:28 2020 - [info] Slave started.
Sun Mar 15 06:56:28 2020 - [info] gtid_wait(5ee7fdc6-65e7-11ea-9406-000c2950e14e:1-305,
655ed904-65e7-11ea-82db-000c299aa4ae:1-42) completed on 192.168.188.203(192.168.188.203:3306). Executed 0 events.
Sun Mar 15 06:56:29 2020 - [info] End of log messages from 192.168.188.203.
Sun Mar 15 06:56:29 2020 - [info] -- Slave on host 192.168.188.203(192.168.188.203:3306) started.
Sun Mar 15 06:56:29 2020 - [info] All new slave servers recovered successfully.
Sun Mar 15 06:56:29 2020 - [info] 
Sun Mar 15 06:56:29 2020 - [info] * Phase 5: New master cleanup phase..

# 新master执行： stop slave;   reset slave all;  


Sun Mar 15 06:56:29 2020 - [info] 
Sun Mar 15 06:56:29 2020 - [info] Resetting slave info on the new master..
Sun Mar 15 06:56:29 2020 - [info]  192.168.188.201: Resetting slave info succeeded.
Sun Mar 15 06:56:29 2020 - [info] Master failover to 192.168.188.201(192.168.188.201:3306) completed successfully.
Sun Mar 15 06:56:29 2020 - [info] 
 
----- Failover Report -----
 
app1: MySQL Master failover 192.168.188.202(192.168.188.202:3306) to 192.168.188.201(192.168.188.201:3306) succeeded
 
Master 192.168.188.202(192.168.188.202:3306) is down!
 
Check MHA Manager logs at mysqlvm1-4:/var/log/masterha/app1/manager.log for details.
 
Started automated(non-interactive) failover.
Invalidated master IP address on 192.168.188.202(192.168.188.202:3306)
Selected 192.168.188.201(192.168.188.201:3306) as a new master.
192.168.188.201(192.168.188.201:3306): OK: Applying all logs succeeded.
192.168.188.201(192.168.188.201:3306): OK: Activated master IP address.
192.168.188.203(192.168.188.203:3306): OK: Slave started, replicating from 192.168.188.201(192.168.188.201:3306)
192.168.188.201(192.168.188.201:3306): Resetting slave info succeeded.
Master failover to 192.168.188.201(192.168.188.201:3306) completed successfully.
[root@mysqlvm1-4 app1]# 
```



 

 

## 进一步探索

  此时再进行rep检查

```

[root@mysqlvm1-4 app1]# masterha_check_repl --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf 
Mon Mar 16 22:26:48 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..
Mon Mar 16 22:26:48 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..
Mon Mar 16 22:26:48 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..
Mon Mar 16 22:26:48 2020 - [info] MHA::MasterMonitor version 0.58.
Mon Mar 16 22:26:49 2020 - [info] GTID failover mode = 1
Mon Mar 16 22:26:49 2020 - [info] Dead Servers:
Mon Mar 16 22:26:49 2020 - [info]  192.168.188.202(192.168.188.202:3306)
Mon Mar 16 22:26:49 2020 - [info] Alive Servers:
Mon Mar 16 22:26:49 2020 - [info]  192.168.188.201(192.168.188.201:3306)
Mon Mar 16 22:26:49 2020 - [info]  192.168.188.203(192.168.188.203:3306)
Mon Mar 16 22:26:49 2020 - [info] Alive Slaves:
Mon Mar 16 22:26:49 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
Mon Mar 16 22:26:49 2020 - [info]   GTID ON
Mon Mar 16 22:26:49 2020 - [info]   Replicating from 192.168.188.201(192.168.188.201:3306)
Mon Mar 16 22:26:49 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
Mon Mar 16 22:26:49 2020 - [info] Current Alive Master: 192.168.188.201(192.168.188.201:3306)
Mon Mar 16 22:26:49 2020 - [info] Checking slave configurations..
Mon Mar 16 22:26:49 2020 - [info] Checking replication filtering settings..
Mon Mar 16 22:26:49 2020 - [info] binlog_do_db= , binlog_ignore_db= 
Mon Mar 16 22:26:49 2020 - [info] Replication filtering check ok.
Mon Mar 16 22:26:49 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.
Mon Mar 16 22:26:49 2020 - [error][/usr/share/perl5/vendor_perl/MHA/ServerManager.pm, ln492] Server 192.168.188.202(192.168.188.202:3306) is dead, but must be alive! Check server settings.
Mon Mar 16 22:26:49 2020 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln427] Error happened on checking configurations. at /usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm line 402.
Mon Mar 16 22:26:49 2020 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln525] Error happened on monitoring servers.
Mon Mar 16 22:26:49 2020 - [info] Got exit code 1 (Not master dead).
 
MySQL Replication Health is NOT OK!
 
```



- 将node2，也就是原master启动起来

  ```
  **mysql> show slave status \G**                   -------------空空如也
  Empty set (0.00 sec)
 
  **mysql> show master status \G**
  *************************** 1. row ***************************
  ​       File: mysql-bin.000007
  ​     Position: 234
     Binlog_Do_DB: 
   Binlog_Ignore_DB: 
  Executed_Gtid_Set: 5ee7fdc6-65e7-11ea-9406-000c2950e14e:1-305,
  655ed904-65e7-11ea-82db-000c299aa4ae:1-42
  1 row in set (0.00 sec)
  ```
  
- 作为从节点加入集群

  ```
  **mysql> change master to master_host='192.168.188.201',master_port=3306,master_user='rep',master_password='rep',master_auto_position=1;**
  
  Query OK, 0 rows affected, 2 warnings (0.02 sec)
  ```

- 启动slave
    ```
    **mysql> start slave;**
    Query OK, 0 rows affected (0.00 sec)

    **mysql> show slave status \G**
    *************************** 1. row ***************************
            Slave_IO_State: Waiting for master to send event
             Master_Host: 192.168.188.201
             Master_User: rep
             Master_Port: 3306
            Connect_Retry: 60
           Master_Log_File: mysql-bin.000004
         Read_Master_Log_Pos: 13886
            Relay_Log_File: mysqlvm1-2-relay-bin.000002
            Relay_Log_Pos: 414
        Relay_Master_Log_File: mysql-bin.000004
           Slave_IO_Running: Yes
          Slave_SQL_Running: Yes
                Exec_Master_Log_Pos: 13886
           Relay_Log_Space: 626
                 Master_Server_Id: 10243306
             Master_UUID: 5ee7fdc6-65e7-11ea-9406-000c2950e14e
           Master_Info_File: mysql.slave_master_info
              SQL_Delay: 0
         SQL_Remaining_Delay: NULL
       Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
          Master_Retry_Count: 86400
             Master_Bind: 
       Last_IO_Error_Timestamp: 
       Last_SQL_Error_Timestamp: 
            Master_SSL_Crl: 
          Master_SSL_Crlpath: 
          Retrieved_Gtid_Set: 
          Executed_Gtid_Set: 5ee7fdc6-65e7-11ea-9406-000c2950e14e:1-305,
    655ed904-65e7-11ea-82db-000c299aa4ae:1-42
            Auto_Position: 1
    1 row in set (0.00 sec)
    ```

- 再次检查MHA repl

    ```
    
    **[root@mysqlvm1-4 app1]# masterha_check_repl --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf** 
    Mon Mar 16 22:28:57 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..
    Mon Mar 16 22:28:57 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..
    Mon Mar 16 22:28:57 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..
    Mon Mar 16 22:28:57 2020 - [info] MHA::MasterMonitor version 0.58.
    Mon Mar 16 22:28:58 2020 - [info] GTID failover mode = 1
    Mon Mar 16 22:28:58 2020 - [info] Dead Servers:
    Mon Mar 16 22:28:58 2020 - [info] Alive Servers:
    Mon Mar 16 22:28:58 2020 - [info]  192.168.188.201(192.168.188.201:3306)
    Mon Mar 16 22:28:58 2020 - [info]  192.168.188.202(192.168.188.202:3306)
    Mon Mar 16 22:28:58 2020 - [info]  192.168.188.203(192.168.188.203:3306)
    Mon Mar 16 22:28:58 2020 - [info] Alive Slaves:
    Mon Mar 16 22:28:58 2020 - [info]  192.168.188.202(192.168.188.202:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
    Mon Mar 16 22:28:58 2020 - [info]   GTID ON
    Mon Mar 16 22:28:58 2020 - [info]   Replicating from 192.168.188.201(192.168.188.201:3306)
    Mon Mar 16 22:28:58 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
    Mon Mar 16 22:28:58 2020 - [info]  192.168.188.203(192.168.188.203:3306) Version=5.7.26-log (oldest major version between slaves) log-bin:enabled
    Mon Mar 16 22:28:58 2020 - [info]   GTID ON
    Mon Mar 16 22:28:58 2020 - [info]   Replicating from 192.168.188.201(192.168.188.201:3306)
    Mon Mar 16 22:28:58 2020 - [info]   Primary candidate for the new Master (candidate_master is set)
    Mon Mar 16 22:28:58 2020 - [info] Current Alive Master: 192.168.188.201(192.168.188.201:3306)
    Mon Mar 16 22:28:58 2020 - [info] Checking slave configurations..
    Mon Mar 16 22:28:58 2020 - [info] Checking replication filtering settings..
    Mon Mar 16 22:28:58 2020 - [info] binlog_do_db= , binlog_ignore_db= 
    Mon Mar 16 22:28:58 2020 - [info] Replication filtering check ok.
    Mon Mar 16 22:28:58 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.
    Mon Mar 16 22:28:58 2020 - [info] Checking SSH publickey authentication settings on the current master..
    Mon Mar 16 22:28:58 2020 - [info] HealthCheck: SSH to 192.168.188.201 is reachable.
    Mon Mar 16 22:28:58 2020 - [info] 
    192.168.188.201(192.168.188.201:3306) (current master)
     +--192.168.188.202(192.168.188.202:3306)
     +--192.168.188.203(192.168.188.203:3306)
     
    Mon Mar 16 22:28:58 2020 - [info] Checking replication health on 192.168.188.202..
    Mon Mar 16 22:28:58 2020 - [info] ok.
    Mon Mar 16 22:28:58 2020 - [info] Checking replication health on 192.168.188.203..
    Mon Mar 16 22:28:58 2020 - [info] ok.
    Mon Mar 16 22:28:58 2020 - [info] Checking master_ip_failover_script status:
    Mon Mar 16 22:28:58 2020 - [info]  /etc/masterha/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.188.201 --orig_master_ip=192.168.188.201 --orig_master_port=3306 
    Mon Mar 16 22:28:59 2020 - [info] OK.
    Mon Mar 16 22:28:59 2020 - [warning] shutdown_script is not defined.
    Mon Mar 16 22:28:59 2020 - [info] Got exit code 0 (Not master dead).
     
    MySQL Replication Health is OK.
    ```

    

- 想起此时MHA manager还没启动呢， 启动一下。

    ```
    **[root@mysqlvm1-4 app1]# masterha_check_s --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf** 
    masterha_check_ssh   masterha_check_status 
    **[root@mysqlvm1-4 app1]# masterha_check_status --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf** 
    app1 is stopped(2:NOT_RUNNING).
    **[root@mysqlvm1-4 app1]# masterha_manager --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf** 
    Mon Mar 16 22:29:22 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..
    Mon Mar 16 22:29:22 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..
    Mon Mar 16 22:29:22 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..
    ```



# MHA node 初试

 ```
[root@mysqlvm1-1 ~]# rpm -ql mha4mysql-node
/usr/bin/apply_diff_relay_logs
/usr/bin/filter_mysqlbinlog
/usr/bin/purge_relay_logs
/usr/bin/**save_binary_logs**  MHA的灵魂
/usr/share/man/man1/apply_diff_relay_logs.1.gz
/usr/share/man/man1/filter_mysqlbinlog.1.gz
/usr/share/man/man1/purge_relay_logs.1.gz
/usr/share/man/man1/save_binary_logs.1.gz
/usr/share/perl5/vendor_perl/MHA/BinlogHeaderParser.pm
/usr/share/perl5/vendor_perl/MHA/BinlogManager.pm
/usr/share/perl5/vendor_perl/MHA/BinlogPosFindManager.pm
/usr/share/perl5/vendor_perl/MHA/BinlogPosFinder.pm
/usr/share/perl5/vendor_perl/MHA/BinlogPosFinderElp.pm
/usr/share/perl5/vendor_perl/MHA/BinlogPosFinderXid.pm
/usr/share/perl5/vendor_perl/MHA/NodeConst.pm
/usr/share/perl5/vendor_perl/MHA/NodeUtil.pm
/usr/share/perl5/vendor_perl/MHA/SlaveUtil.pm
 ```

- MHA node 各脚本功能

| save_binary_logs      | 保存和复制master的二进制日志                            |
| --------------------- | ------------------------------------------------------- |
| apply_diff_relay_logs | 识别差异的中继日志事件并将其差异的事件应用于其他的slave |
| filter_mysqlbinlog    | 去除不必要的ROLLBACK事件（MHA已不再使用这个工具）       |
| purge_relay_logs      | 清除中继日志（不会阻塞SQL线程）                         |

- save_binary_logs **MHA的灵魂**

 

## 一般的，我们徒手做binlog补偿，会是这样的顺序：

```
1. show slave status \G
		master_log_file=xxx
		read_master_log_pos=123

2. 并且
		sql_thread == io_thread
	就是说
		master_log_file==relay_master_log_file
		master_log_pos==Read_Master_Log_Pos=Exec_Master_Log_Pos
		Retrieved_Gtid_Set==Executed_Gtid_Set

3. 然后，依据filename和position，去获取master的日志，并重放在新master上
	mysqlbinlog --start-position=Read_Master_Log_Pos master_log_file > $[new_master]
```

**save_binary_logs便是实现这个逻辑的。**