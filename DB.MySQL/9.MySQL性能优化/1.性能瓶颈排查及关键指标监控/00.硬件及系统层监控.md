[TOC]



监控的核心目的是保证整体业务可用，不能只监控部分环节

 

# 硬件及系统层

| CPU  | %user，%sys，%idle，%iowait，是否发生中断不均衡 |
| ---- | ----------------------------------------------- |
| 内存 | available，cached，swap，内存泄漏及OOM          |
| I/O  | iops、吞吐、时延、利用率%util                   |
| 网卡 | 吞吐，特别关注小包的收发频率                    |

 

## CPU：

mysqld 的话

- user% 高， 检查索引；
- sys%高，检查是否发生了swap，是否未关闭NUMA，mysqld进程是否调度了os的别的进程，是否发生了行锁等待，os层硬件中断由特定的逻辑核心处理；
- iowait%高，IO子系统性能差或负载高，或设定配置不合理如调度模式设置错误，文件系统错误等原因。

 

## 内存：

内存主要看是否发生swap和内存泄漏

 

## I/O：

iops的抖动情况做分析，规律性增高可能是业务量上升。吞吐量为每秒读写的bytes数，

MGR最好用万兆网

 

## 系统监控

### 常规工具

- top，注意观察CPU和load avg
- free， 注意观察内存是否存在泄漏。ps
- df
- sar
- mpstat
- iostat
- dstat
- iotop
- ss/netstat，netstat比较大机会会造成性能瓶颈， 使用ss替代
- ethstatus
- arping

### 其他工具

- perf top/report
- pstack，可以将进程所有堆栈调用都打印出来，再用ps-pmp分析，找到导致进程hang的原因

 

## 工具简介

### free

当发现系统已经用了swap，可能是内存不够，也可能是没关numa（重要）。如果只跑mysql，可以考虑关闭swap。

free命令，注意观察内存是否存在泄漏

```
[root@VS-TESTDB01 dumpdir]# free -m
             total       used       free     shared    buffers     cached
Mem:         64560      62286       2273       5107        195      60377
-/+ buffers/cache:       1713      62846
Swap:            0          0          0

- Mem			:物理内存的缓存统计行
- total:64560	:物理内存总量
- used:62286	:实际使用的内存总量
- free2273		:未被分配的内存
- shared:5107	:共享内存
- buffers:195	:未使用的buffer数量
- cached:60377	:未使用的cache数量

- -/+ buffers/cache
- used:1713		:系统当前实际使用的内存总量。
				系统当前实际使用的内存总量 = 实际使用的内存总量 - 未使用的buffer数量 - 未使用的cache数量
				= (mem行)used - cached - free
- free:62846	:系统当前实际可用的内存。  
				系统当前实际可用的内存 = 未被分配的内存 + 未使用的buffer数量 + 未使用的cache数量
				= (mem行)buffers + cached + free
```

 

### vmstat

当发现proc、b、高bi、bo，us也不空闲，可能是没索引

```
[root@zabbix ~]# vmstat -S m 1
procs -----------memory---------- ---swap--  ------io---- -system--  ------cpu-----
 r  b   swpd   free   buff  cache   si   so   bi    bo     in    cs us  sy id  wa st
 1  2     0   1939      1   4598    0    0   52021  21223    0    0 26  10 98  4   0
 7  3     0   1939      1   4598    0    0   62421  21158 1376 1271 26  10 60  4   0
 2  4     0   1939      1   4598    0    0   83221  21137 3460 3474 26  11 60  4   0
 1  8     0   1939      1   4598    0    0  694421  21588 5926 7981 26  11 60  4   0
25  1     0   1939      1   4598    0    0  283221  21190 1223 1097 26  10 60  4   0
50  6     0   1939      1   4598    0    0  302121  21329 5860 7103 26  11 60  4   0
41  3     0   1939      1   4598    0    0   38421  21474  985  866 26  10 60  4   0
11  2     0   1939      1   4598    0    0  233621  21378 1388 1500 26  10 60  4   0
15  4     0   1939      1   4598    0    0  100821  21094 2644 1932 26  10 60  4   0
 7  6     0   1939      1   4598    0    0   73621  21109 2880 1613 26  10 60  4   0
19  2     0   1938      1   4598    0    0  120021  21118 5805 2210 26  10 60  4   0
 0  0     0   1938      1   4598    0    0   57621  21093 1584 1276 26  10 60  4   0
```

 

### mpstat

查看cpu各逻辑核心情况

sys% 在0 1 核心较高时可能是中断不均衡导致

```
10:09:17 AM CPU    HI/s  TIMER/s  NET_TX/s  NET_RX/s  BLOCK/s BLOCK_IOPOLL/s TASKLET/s  SCHED/s HRTIMER/s   RCU/s
10:09:17 AM  0    0.00   23.00    0.12   93.93    0.11    0.00    0.02   13.29    0.00   14.20
10:09:17 AM  1    0.00   13.57    0.00   52.88    0.10    0.00    0.01    6.35    0.00    9.99
10:09:17 AM  2    0.00   16.97    0.00   65.82    0.12    0.00    0.00    7.14    0.00   12.07
10:09:17 AM  3    0.00   16.07    0.00   66.45    0.07    0.00    0.00    6.86    0.00   11.66
10:09:17 AM  4    0.00   11.28    0.00   53.36    0.07    0.00    0.00    5.47    0.00    9.45
10:09:17 AM  5    0.00    6.61    0.00   30.18    0.37    0.00    0.00    4.11    0.00    6.28
10:09:17 AM  6    0.00   16.17    0.00   66.49    0.06    0.00    0.00    6.83    0.00   11.26
10:09:17 AM  7    0.00    6.51    0.00   27.33    0.05    0.00    0.00    4.05    0.00    6.01
10:09:17 AM  8    0.00    9.48    0.00   50.02    0.14    0.00    0.00    5.00    0.00    7.18
10:09:17 AM  9    0.00    6.00    0.00   18.32    0.08    0.00    0.00    3.90    0.00    5.14
10:09:17 AM  10   0.00    5.75    0.00   16.22    0.11    0.00    0.00    3.81    0.00    4.85
```

 

查看CPU中断统计的脚本

```
cat intr.sh
#!/bin/bash
 
 FILE="/proc/interrupts"
 
 output=$(awk 'NR==1 {
 core_count = NF
 print core_count
 next
}
/eth/ {
 for (i = 2; i <= 2+core_count; i++)
 totals[i-2] += $i
}
 
END {
 for (i = 0; i < core_count; i++)
 printf("%d\n", totals[i])
}
' $FILE)
 
core_count=$(echo $output | cut -d' ' -f1)
 
output=$(echo $output | sed 's/^[0-9]*//')
 
totals=(${output// / })
 
echo CC: $core_count total0 ${totals[0]} total1 ${totals[1]}
```



### dstat

​	可以用插件



### iotop

​	除此之外，MySQL可以用P_S中 %io% 名称的表查看io状态， 但前提需要先开启IO相关的统计customer。

 

 



